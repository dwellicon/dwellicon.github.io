<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Live Chat — Login</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{
      --bg:#f2f6fb; --card:#fff; --muted:#7b8794; --accent:#4f46e5; --you:#e9f0ff;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#eef6ff 0%,var(--bg) 100%);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:#0f1724}
    .center{max-width:900px;margin:28px auto;padding:18px}
    .panel{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 8px 30px rgba(20,30,60,0.06)}
    .row{display:flex;gap:12px;align-items:center}
    input[type=text],input[type=password],input[type=email]{padding:10px;border-radius:8px;border:1px solid #eef2f7;width:100%;box-sizing:border-box}
    button{padding:10px 14px;border-radius:8px;border:0;background:var(--accent);color:#fff;cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
    .hidden{display:none}
    .error{color:#b00020;margin-top:8px}
    /* reuse chat styles from earlier (compact) */
    .chat-wrap{margin-top:18px}
    .chat{height:56vh;border-radius:10px;overflow:hidden;display:flex;flex-direction:column}
    #chatList{flex:1;padding:12px;overflow:auto;background:#fbfdff}
    .input-bar{display:flex;gap:8px;padding:10px;border-top:1px solid #eef2f7}
    .input-bar input{flex:1;padding:10px;border-radius:8px;border:1px solid #eef2f7}
  </style>
</head>
<body>
  <div class="center">
    <div id="authPanel" class="panel">
      <h2>Sign in or create an account</h2>
      <div class="muted">Enter a username and password. Username will be shown in chat.</div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px">
        <input id="username" type="text" placeholder="Username (visible in chat)">
        <input id="email" type="email" placeholder="Email (used for login)">
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px">
        <input id="password" type="password" placeholder="Password (min 6 chars)">
        <input id="password2" type="password" placeholder="Confirm password (signup)">
      </div>

      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="signupBtn">Create account</button>
        <button id="signinBtn" style="background:#0ea5a4">Sign in</button>
        <div style="flex:1"></div>
        <button id="continueAnon" style="background:#f59e0b">Continue anonymously</button>
      </div>

      <div id="authError" class="error hidden"></div>
      <div style="margin-top:12px" class="muted">Tip: use a real email for password recovery. For learning, you can use test emails.</div>
    </div>

    <div id="chatPanel" class="panel hidden chat-wrap">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div>
          <strong id="displayName">Guest</strong>
          <div class="muted" id="userIdSmall"></div>
        </div>
        <div>
          <button id="signOutBtn" style="background:#ef4444">Sign out</button>
        </div>
      </div>

      <div class="chat" style="margin-top:12px">
        <div id="chatList"></div>

        <div class="input-bar">
          <input id="msg" placeholder="Write a message…">
          <input id="file" type="file" accept="image/*,video/*,application/pdf" style="display:none">
          <button id="attach">Attach</button>
          <button id="send">Send</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <script>
    // ====== CONFIG: paste your firebaseConfig here ======
    const firebaseConfig = {
      apiKey: "AIzaSyAulcwmA2r2Z0Wv5mxyuWwQvPv05E8HvMU",
      authDomain: "dwellicon-42e72.firebaseapp.com",
      databaseURL: "https://dwellicon-42e72-default-rtdb.firebaseio.com",
      projectId: "dwellicon-42e72",
      storageBucket: "dwellicon-42e72.appspot.com",
      messagingSenderId: "634657717896",
      appId: "1:634657717896:web:27f246614fdb2c2398a93d",
      measurementId: "G-GP1YBL86RB"
    };
    firebase.initializeApp(firebaseConfig);

    // Services
    const auth = firebase.auth();
    const db = firebase.database();
    const storage = firebase.storage().ref();

    // UI elements
    const authPanel = document.getElementById('authPanel');
    const chatPanel = document.getElementById('chatPanel');
    const authError = document.getElementById('authError');
    const usernameEl = document.getElementById('username');
    const emailEl = document.getElementById('email');
    const passwordEl = document.getElementById('password');
    const password2El = document.getElementById('password2');
    const signupBtn = document.getElementById('signupBtn');
    const signinBtn = document.getElementById('signinBtn');
    const continueAnon = document.getElementById('continueAnon');
    const displayNameEl = document.getElementById('displayName');
    const userIdSmall = document.getElementById('userIdSmall');
    const signOutBtn = document.getElementById('signOutBtn');

    const chatList = document.getElementById('chatList');
    const msgInput = document.getElementById('msg');
    const sendBtn = document.getElementById('send');
    const attachBtn = document.getElementById('attach');
    const fileInput = document.getElementById('file');

    // Helpers
    function showError(el, text){ el.textContent = text; el.classList.remove('hidden'); }
    function hideError(el){ el.textContent = ''; el.classList.add('hidden'); }

    // AUTH: create account
    signupBtn.addEventListener('click', async () => {
      hideError(authError);
      const username = (usernameEl.value || '').trim();
      const email = (emailEl.value || '').trim();
      const pw = passwordEl.value || '';
      const pw2 = password2El.value || '';
      if (!username) return showError(authError, 'Choose a username.');
      if (!email) return showError(authError, 'Enter an email.');
      if (pw.length < 6) return showError(authError, 'Password must be at least 6 characters.');
      if (pw !== pw2) return showError(authError, 'Passwords do not match.');

      try {
        // Create user with email/password (secure)
        const cred = await auth.createUserWithEmailAndPassword(email, pw);
        const uid = cred.user.uid;

        // Set displayName in Firebase Auth profile (optional)
        await cred.user.updateProfile({ displayName: username });

        // Store username mapping in Realtime Database under /users/{uid}
        // This is safe because password is handled by Firebase Auth
        await db.ref('users/' + uid).set({
          username: username,
          createdAt: Date.now()
        });

        // After signup, UI will update via onAuthStateChanged
      } catch (err) {
        console.error('signup error', err);
        showError(authError, err.message || String(err));
      }
    });

    // AUTH: sign in
    signinBtn.addEventListener('click', async () => {
      hideError(authError);
      const email = (emailEl.value || '').trim();
      const pw = passwordEl.value || '';
      if (!email) return showError(authError, 'Enter an email.');
      if (!pw) return showError(authError, 'Enter a password.');

      try {
        await auth.signInWithEmailAndPassword(email, pw);
      } catch (err) {
        console.error('signin error', err);
        showError(authError, err.message || String(err));
      }
    });

    // Anonymous sign-in option
    continueAnon.addEventListener('click', async () => {
      hideError(authError);
      try {
        const cred = await auth.signInAnonymously();
        // Optionally set a temporary username in DB
        const uid = cred.user.uid;
        const anonName = 'Guest-' + uid.slice(0,6);
        await db.ref('users/' + uid).set({ username: anonName, anonymous: true, createdAt: Date.now() });
      } catch (err) {
        console.error('anon sign-in error', err);
        showError(authError, err.message || String(err));
      }
    });

    // Sign out
    signOutBtn.addEventListener('click', () => auth.signOut());

    // React to auth state
    auth.onAuthStateChanged(async user => {
      if (user) {
        // Hide auth panel, show chat
        authPanel.classList.add('hidden');
        chatPanel.classList.remove('hidden');

        // Load username from DB (if set)
        const uid = user.uid;
        userIdSmall.textContent = uid;
        try {
          const snap = await db.ref('users/' + uid).once('value');
          const profile = snap.val() || {};
          const username = profile.username || user.displayName || 'Guest';
          displayNameEl.textContent = username;
          // Save locally
          localStorage.setItem('chat_name', username);
          // Start listening to messages
          startChat();
        } catch (err) {
          console.error('load profile error', err);
          displayNameEl.textContent = user.displayName || 'Guest';
          startChat();
        }
      } else {
        // Show auth panel
        authPanel.classList.remove('hidden');
        chatPanel.classList.add('hidden');
        stopChat();
      }
    });

    // CHAT logic (simple)
    let messagesRef = null;
    function startChat(){
      // avoid multiple listeners
      if (messagesRef) return;
      messagesRef = db.ref('messages');
      messagesRef.limitToLast(200).on('child_added', snap => {
        const data = snap.val();
        appendMessage(data);
      });
    }
    function stopChat(){
      if (!messagesRef) return;
      messagesRef.off();
      messagesRef = null;
      chatList.innerHTML = '';
    }

    function appendMessage(data){
      const el = document.createElement('div');
      el.style.margin = '8px 0';
      const name = document.createElement('div');
      name.textContent = (data.name || 'Guest') + ' • ' + new Date(data.ts || Date.now()).toLocaleTimeString();
      name.style.fontSize = '12px';
      name.style.color = '#6b7280';
      const body = document.createElement('div');
      body.textContent = data.text || '';
      body.style.padding = '8px';
      body.style.background = '#fff';
      body.style.borderRadius = '8px';
      el.appendChild(name);
      el.appendChild(body);
      if (data.imageUrl) {
        const img = document.createElement('img');
        img.src = data.imageUrl;
        img.style.maxWidth = '240px';
        img.style.display = 'block';
        img.style.marginTop = '8px';
        el.appendChild(img);
      }
      chatList.appendChild(el);
      chatList.scrollTop = chatList.scrollHeight;
    }

    // Send message
    sendBtn.addEventListener('click', async () => {
      const text = (msgInput.value || '').trim().slice(0,300);
      if (!text) return;
      const user = auth.currentUser;
      if (!user) return alert('Not signed in');
      const uid = user.uid;
      // get username from DB or localStorage
      const name = localStorage.getItem('chat_name') || user.displayName || 'Guest';
      try {
        await db.ref('messages').push({ name, text, ts: Date.now(), uid });
        msgInput.value = '';
      } catch (err) {
        console.error('send error', err);
        alert('Send failed: ' + (err.message || err));
      }
    });

    // Attach/upload flow (same pattern as earlier)
    attachBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const user = auth.currentUser;
      if (!user) return alert('Not signed in');
      // Basic validation
      const maxBytes = 5 * 1024 * 1024;
      if (file.size > maxBytes) return alert('File too large (max 5MB)');
      const safeName = file.name.replace(/[^a-zA-Z0-9.\-_]/g, '_');
      const path = `uploads/${firebaseConfig.projectId}/${Date.now()}_${safeName}`;
      const ref = storage.child(path);
      try {
        const task = ref.put(file, { contentType: file.type });
        task.on('state_changed', snap => {
          // progress could be shown
        }, err => {
          console.error('upload error', err);
          alert('Upload failed: ' + (err.message || err));
        }, async () => {
          const url = await ref.getDownloadURL();
          const name = localStorage.getItem('chat_name') || user.displayName || 'Guest';
          await db.ref('messages').push({ name, text: '', imageUrl: url, fileName: file.name, contentType: file.type, ts: Date.now(), uid: user.uid });
        });
      } catch (err) {
        console.error('attach error', err);
        alert('Attach failed: ' + (err.message || err));
      }
      fileInput.value = '';
    });

    // Basic client-side username persistence
    const saved = localStorage.getItem('chat_name');
    if (saved) usernameEl.value = saved;

    // Save username locally when changed
    usernameEl.addEventListener('change', () => localStorage.setItem('chat_name', usernameEl.value.trim()));
  </script>
</body>
</html>
