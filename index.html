<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Chat with Servers, Private Channels, Members & Admin Tools</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#f2f6fb;
      --card:#ffffff;
      --muted:#7b8794;
      --accent:#4f46e5;
      --admin-yellow:#f59e0b;
      --you:#e9f0ff;
      --shadow: 0 8px 30px rgba(20,30,60,0.06);
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#eef6ff 0%,var(--bg) 100%);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:#0f1724}
    .app { display:flex; height:100vh; overflow:hidden; }

    /* Servers column (left) - Discord style vertical circles */
    .servers-column {
      width:72px; min-width:72px;
      background:#0f1724; color:white;
      display:flex; flex-direction:column; align-items:center;
      padding:10px 8px; gap:8px; box-shadow: 4px 0 18px rgba(2,6,23,0.12);
    }
    .server-list { flex:1; width:100%; overflow:auto; display:flex; flex-direction:column; gap:8px; align-items:center; padding:6px 0; }
    .server { width:48px; height:48px; border-radius:50%; background:#111827; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; cursor:pointer; border:2px solid transparent; transition:all .12s; user-select:none; position:relative; }
    .server:hover { transform:scale(1.04); }
    .server.active { border-color:var(--accent); box-shadow:0 6px 18px rgba(79,70,229,0.12); }
    .server .label { font-size:12px; pointer-events:none; }
    .create-server-btn { width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,#06b6d4,#4f46e5);display:flex;align-items:center;justify-content:center;cursor:pointer;border:0; }
    .create-server-btn svg{width:20px;height:20px;color:white}
    .server-name { font-size:11px; color:#cbd5e1; margin-top:4px; text-align:center; width:64px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    /* Main area */
    .main-column { flex:1; display:flex; min-width:0; }
    .chat-column{flex:1;display:flex;flex-direction:column;background:var(--card);border-right:1px solid #e6edf6;box-shadow:var(--shadow);min-width:0}
    header{display:flex;align-items:center;gap:12px;padding:14px 18px;border-bottom:1px solid #eef2f7;background:linear-gradient(90deg, rgba(79,70,229,0.02), transparent)}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#06b6d4);display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
    header h1{font-size:16px;margin:0}
    header p{margin:0;color:var(--muted);font-size:13px}
    .header-right{margin-left:auto;display:flex;gap:10px;align-items:center}
    .name-input{padding:8px 10px;border-radius:8px;border:1px solid #eef2f7;width:160px}
    #chat{flex:1;padding:18px;overflow:auto;display:flex;flex-direction:column;gap:10px;background:linear-gradient(180deg,rgba(79,70,229,0.02),transparent)}
    .msg{padding:10px;background:#fff;border-radius:10px;box-shadow:0 1px 0 rgba(0,0,0,0.03);max-width:70%;word-break:break-word;position:relative}
    .msg .meta{font-size:12px;color:var(--muted);margin-bottom:6px;display:flex;gap:8px;align-items:center}
    .admin-badge{background:var(--admin-yellow);color:#1f2937;padding:2px 8px;border-radius:999px;font-weight:700;font-size:11px}
    .input-bar{display:flex;gap:10px;padding:12px;border-top:1px solid #eef2f7;background:#f8fafc;align-items:center}
    .input{flex:1;display:flex;gap:8px;align-items:center;background:#fff;padding:8px;border-radius:10px;border:1px solid #eef2f7}
    .input input{flex:1;border:0;background:transparent;padding:8px;font-size:14px;outline:none}
    .btn{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:600}
    .btn.send{background:var(--accent);color:#fff}
    .btn.attach{background:#10b981;color:#fff}

    /* Members column (right) */
    .members-column{width:300px;min-width:220px;max-width:360px;background:#fbfdff;border-left:1px solid #e6edf6;display:flex;flex-direction:column}
    .members-header{padding:14px 16px;border-bottom:1px solid #eef2f7;display:flex;align-items:center;justify-content:space-between}
    .members-header h3{margin:0;font-size:14px;display:flex;gap:8px;align-items:center}
    .members-list{padding:12px;overflow:auto;flex:1}
    .member{display:flex;gap:10px;align-items:center;padding:8px;border-radius:8px;transition:background .12s;cursor:pointer}
    .member:hover{background:rgba(15,23,36,0.03)}
    .member .avatar{width:40px;height:40px;border-radius:8px;background:#c7d2fe;color:#0f1724;display:flex;align-items:center;justify-content:center;font-weight:700}
    .member .info{display:flex;flex-direction:column}
    .member .name{font-weight:600;font-size:14px;display:flex;gap:8px;align-items:center}
    .member .status{font-size:12px;color:var(--muted)}

    /* Modals & overlays */
    .overlay{position:fixed;inset:0;background:rgba(10,12,20,0.45);display:flex;align-items:center;justify-content:center;z-index:999;display:none}
    .modal{background:white;padding:16px;border-radius:10px;min-width:320px;box-shadow:0 12px 40px rgba(10,20,40,0.3)}
    .modal h3{margin:0 0 8px 0}
    .modal .row{display:flex;gap:8px;margin-top:12px}
    .danger{background:#ef4444;color:white}
    .muted{color:var(--muted);font-size:13px}
    .banner{position:fixed;left:16px;bottom:16px;background:#fff;padding:10px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.08);font-size:13px;display:none}
    .block-screen{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:1000;color:white;font-size:18px;display:none}
    .block-screen .card{background:rgba(255,255,255,0.06);padding:20px;border-radius:10px;text-align:center}
    .tab-row{display:flex;gap:8px;margin-bottom:12px}
    .tab{padding:8px 12px;border-radius:8px;cursor:pointer;background:#f3f4f6}
    .tab.active{background:var(--accent);color:white}
    .server-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #eef2f7}
    .lock-icon{margin-left:8px;color:#f59e0b}

    /* custom context menu */
    #serverContextMenu {
      position: fixed;
      z-index: 2000;
      background: white;
      border-radius: 8px;
      box-shadow: 0 8px 30px rgba(10,20,40,0.2);
      padding: 8px;
      display: none;
      min-width: 160px;
      font-size: 14px;
      color: #0f1724;
    }
    #serverContextMenu button {
      display:block;
      width:100%;
      text-align:left;
      padding:8px;
      border:0;
      background:transparent;
      cursor:pointer;
      border-radius:6px;
    }
    #serverContextMenu button:hover { background:#f3f4f6; }

    @media (max-width:900px){ .members-column{display:none} .servers-column{display:none} }
  </style>
</head>
<body>
  <div class="app">
    <!-- Servers column -->
    <div class="servers-column" aria-label="Servers">
      <button id="createServerBtn" class="create-server-btn" title="Servers" aria-label="Servers">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 5v14M5 12h14"></path>
        </svg>
      </button>

      <div class="server-list" id="serverList" role="list"></div>

      <div style="height:8px"></div>
    </div>

    <!-- Main chat + members -->
    <div class="main-column">
      <div class="chat-column">
        <header>
          <div class="logo">C</div>
          <div>
            <h1 id="currentServerTitle">Private Chat</h1>
            <p class="muted" id="currentServerSubtitle">Real-time messages — select a server</p>
          </div>
          <div class="header-right">
            <input id="displayNameInput" class="name-input" type="text" placeholder="Your name">
            <button id="adminLoginBtn" class="icon-btn" title="Admin login">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 10v6a2 2 0 0 1-2 2h-3v-3h-4v3H5a2 2 0 0 1-2-2V7a4 4 0 0 1 4-4h6"></path>
                <circle cx="8.5" cy="11.5" r="1.5"></circle>
              </svg>
            </button>
            <button id="adminLogoutBtn" class="btn" style="background:#ef4444;color:#fff;display:none">Logout</button>
          </div>
        </header>

        <div id="chat" aria-live="polite"></div>

        <div class="input-bar">
          <div class="input" role="group" aria-label="Message input">
            <input id="msg" type="text" placeholder="Write a message…" aria-label="Message">
          </div>
          <button id="attach" class="btn attach" aria-label="Attach file">Attach</button>
          <button id="send" class="btn send" aria-label="Send message">Send</button>
        </div>
      </div>

      <aside class="members-column" aria-label="Members">
        <div class="members-header">
          <h3>Members</h3>
          <div id="onlineCount" class="muted">0 online</div>
        </div>
        <div class="members-list" id="membersList"></div>
      </aside>
    </div>
  </div>

  <!-- Create / Join modal (combined) -->
  <div id="createJoinModal" class="overlay">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="tab-row">
        <div id="tabCreate" class="tab active">Create Server</div>
        <div id="tabJoin" class="tab">Join Server</div>
      </div>

      <!-- Create -->
      <div id="createPane">
        <h3>Create Server</h3>
        <div style="margin-top:8px" class="muted">Admins can create persistent servers. Choose Public or Private.</div>
        <div style="margin-top:12px">
          <input id="newServerName" type="text" placeholder="Server name" style="width:100%;padding:10px;border-radius:8px;border:1px solid #eef2f7">
        </div>
        <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
          <label><input type="radio" name="serverType" value="public" checked> Public</label>
          <label><input type="radio" name="serverType" value="private"> Private</label>
        </div>
        <div id="privatePasswordRow" style="margin-top:8px;display:none">
          <input id="newServerPassword" type="password" placeholder="Password for private server" style="width:100%;padding:10px;border-radius:8px;border:1px solid #eef2f7">
        </div>
        <div class="row" style="margin-top:12px">
          <button id="createServerSubmit" class="btn" style="background:#4f46e5;color:#fff">Create</button>
          <button id="createServerCancel" class="btn" style="background:#e5e7eb">Close</button>
        </div>
        <div id="createServerError" class="muted" style="color:#b00020;margin-top:8px;display:none"></div>
      </div>

      <!-- Join -->
      <div id="joinPane" style="display:none">
        <h3>Join Server</h3>
        <div style="margin-top:8px" class="muted">Public servers are listed below. Private servers are not listed — to join a private server, enter its exact name and password in the form.</div>

        <div style="margin-top:12px;max-height:180px;overflow:auto;border:1px solid #eef2f7;border-radius:8px;padding:6px" id="publicJoinList"></div>

        <div style="margin-top:12px;border-top:1px dashed #eef2f7;padding-top:12px">
          <div style="font-weight:600;margin-bottom:6px">Join private server</div>
          <input id="joinServerName" type="text" placeholder="Server name (exact)" style="width:100%;padding:10px;border-radius:8px;border:1px solid #eef2f7;margin-bottom:8px">
          <input id="joinServerPassword" type="password" placeholder="Password" style="width:100%;padding:10px;border-radius:8px;border:1px solid #eef2f7;margin-bottom:8px">
          <div style="display:flex;gap:8px">
            <button id="joinPrivateSubmit" class="btn" style="background:#4f46e5;color:#fff">Join Private</button>
            <button id="joinClose" class="btn" style="background:#e5e7eb">Close</button>
          </div>
          <div id="joinError" class="muted" style="color:#b00020;margin-top:8px;display:none"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Member modal -->
  <div id="memberModal" class="overlay">
    <div class="modal" role="dialog" aria-modal="true">
      <h3 id="modalName">Member</h3>
      <div id="modalUid" class="muted" style="font-size:12px"></div>
      <div style="margin-top:10px" id="modalStatus" class="muted"></div>
      <div class="row" style="margin-top:12px">
        <button id="kickBtn" class="btn danger">Kick</button>
        <button id="banBtn" class="btn" style="background:#6b7280;color:#fff">Ban</button>
        <button id="closeModal" class="btn" style="background:#e5e7eb">Close</button>
      </div>
    </div>
  </div>

  <!-- Admin login modal -->
  <div id="adminModal" class="overlay">
    <div class="modal" role="dialog" aria-modal="true">
      <h3>Administrator Login</h3>
      <div style="margin-top:8px" class="muted">Enter local admin credentials (stored only in this browser).</div>
      <div style="margin-top:12px">
        <input id="adminUser" type="text" placeholder="Username" style="width:100%;padding:10px;border-radius:8px;border:1px solid #eef2f7">
      </div>
      <div style="margin-top:8px">
        <input id="adminPass" type="password" placeholder="Password" style="width:100%;padding:10px;border-radius:8px;border:1px solid #eef2f7">
      </div>
      <div class="row" style="margin-top:12px">
        <button id="adminSubmit" class="btn" style="background:#4f46e5;color:#fff">Login</button>
        <button id="adminCancel" class="btn" style="background:#e5e7eb">Cancel</button>
      </div>
      <div id="adminError" class="muted" style="color:#b00020;margin-top:8px;display:none"></div>
    </div>
  </div>

  <!-- Banland modal -->
  <div id="banlandModal" class="overlay">
    <div class="modal" role="dialog" aria-modal="true">
      <h3>Banland (unban)</h3>
      <div id="banList" style="max-height:300px;overflow:auto;margin-top:8px"></div>
      <div class="row" style="margin-top:12px">
        <button id="closeBanland" class="btn" style="background:#e5e7eb">Close</button>
      </div>
    </div>
  </div>

  <!-- Kicked / Banned full-screen blocks -->
  <div id="kickedScreen" class="block-screen">
    <div class="card">
      <div style="font-size:20px;font-weight:700">You were kicked</div>
      <div style="margin-top:8px">You cannot send messages in this session. Wait until kick expires or an admin removes it.</div>
    </div>
  </div>

  <div id="bannedScreen" class="block-screen">
    <div class="card">
      <div style="font-size:20px;font-weight:700">You are banned</div>
      <div style="margin-top:8px">This browser is banned from this chat. Unban from Banland to restore access.</div>
    </div>
  </div>

  <div id="banner" class="banner"></div>

  <!-- server context menu -->
  <div id="serverContextMenu" role="menu" aria-hidden="true"></div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    /* ====== CONFIG: paste your firebaseConfig here ====== */
    const firebaseConfig = {
      apiKey: "AIzaSyAulcwmA2r2Z0Wv5mxyuWwQvPv05E8HvMU",
      authDomain: "dwellicon-42e72.firebaseapp.com",
      databaseURL: "https://dwellicon-42e72-default-rtdb.firebaseio.com",
      projectId: "dwellicon-42e72",
      storageBucket: "dwellicon-42e72.appspot.com",
      messagingSenderId: "634657717896",
      appId: "1:634657717896:web:27f246614fdb2c2398a93d",
      measurementId: "G-GP1YBL86RB"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // DOM refs
    const serverListEl = document.getElementById('serverList');
    const createServerBtn = document.getElementById('createServerBtn');
    const createJoinModal = document.getElementById('createJoinModal');
    const tabCreate = document.getElementById('tabCreate');
    const tabJoin = document.getElementById('tabJoin');
    const createPane = document.getElementById('createPane');
    const joinPane = document.getElementById('joinPane');
    const newServerName = document.getElementById('newServerName');
    const newServerPassword = document.getElementById('newServerPassword');
    const privatePasswordRow = document.getElementById('privatePasswordRow');
    const createServerSubmit = document.getElementById('createServerSubmit');
    const createServerCancel = document.getElementById('createServerCancel');
    const createServerError = document.getElementById('createServerError');

    const publicJoinList = document.getElementById('publicJoinList');
    const joinList = document.getElementById('joinList');
    const joinClose = document.getElementById('joinClose');
    const joinError = document.getElementById('joinError');
    const joinServerName = document.getElementById('joinServerName');
    const joinServerPassword = document.getElementById('joinServerPassword');
    const joinPrivateSubmit = document.getElementById('joinPrivateSubmit');

    const chatEl = document.getElementById('chat');
    const msgInput = document.getElementById('msg');
    const sendBtn = document.getElementById('send');
    const displayNameInput = document.getElementById('displayNameInput');
    const membersListEl = document.getElementById('membersList');
    const onlineCountEl = document.getElementById('onlineCount');
    const banner = document.getElementById('banner');

    const adminLoginBtn = document.getElementById('adminLoginBtn');
    const adminModal = document.getElementById('adminModal');
    const adminUser = document.getElementById('adminUser');
    const adminPass = document.getElementById('adminPass');
    const adminSubmit = document.getElementById('adminSubmit');
    const adminCancel = document.getElementById('adminCancel');
    const adminError = document.getElementById('adminError');
    const adminLogoutBtn = document.getElementById('adminLogoutBtn');

    const memberModal = document.getElementById('memberModal');
    const modalName = document.getElementById('modalName');
    const modalUid = document.getElementById('modalUid');
    const modalStatus = document.getElementById('modalStatus');
    const kickBtn = document.getElementById('kickBtn');
    const banBtn = document.getElementById('banBtn');
    const closeModal = document.getElementById('closeModal');

    const banlandModal = document.getElementById('banlandModal');
    const banListEl = document.getElementById('banList');
    const banlandBtn = document.getElementById('banlandBtn');
    const closeBanland = document.getElementById('closeBanland');

    const kickedScreen = document.getElementById('kickedScreen');
    const bannedScreen = document.getElementById('bannedScreen');

    const serverContextMenu = document.getElementById('serverContextMenu');

    // DB paths
    const PRESENCE_ROOT = 'presence';
    const SERVERS_ROOT = 'servers';
    const MESSAGES_ROOT = 'messages'; // messages/{serverId}/{messageId}
    const KICKS_ROOT = 'kicks';
    const BANS_ROOT = 'bans';

    // Admin credentials (stored locally only)
    const ADMIN_USERNAME = 'Kyson';
    const ADMIN_PASSWORD = '12345678';

    // state
    let currentServerId = null;
    let serversRef = null;
    let messagesRef = null;
    let lastContextServerId = null;

    // helpers
    function showBanner(text, ms = 2500) {
      banner.textContent = text;
      banner.style.display = 'block';
      setTimeout(()=> banner.style.display = 'none', ms);
    }
    function now() { return Date.now(); }

    // user helpers
    function currentUser() {
      const stored = localStorage.getItem('chat_user');
      if (stored) return JSON.parse(stored);
      const guestName = 'Guest-' + Math.random().toString(36).slice(2,8);
      const uid = 'guest_' + Date.now().toString(36);
      const user = { username: guestName, uid, isAdmin: false };
      localStorage.setItem('chat_user', JSON.stringify(user));
      return user;
    }
    function saveUser(u) { localStorage.setItem('chat_user', JSON.stringify(u)); }

    function isAdminLocal() {
      const u = currentUser();
      return !!u.isAdmin;
    }

    function setUserName(name) {
      const u = currentUser();
      u.username = name;
      if (localStorage.getItem('admin_logged_in') === '1' && name === ADMIN_USERNAME) u.isAdmin = true;
      saveUser(u);
      db.ref(`${PRESENCE_ROOT}/${u.uid}`).update({ username: name, isAdmin: u.isAdmin }).catch(()=>{});
      updateAdminUI();
    }

    function updateAdminUI() {
      if (isAdminLocal()) adminLogoutBtn.style.display = 'inline-block';
      else adminLogoutBtn.style.display = 'none';
    }

    // Helpers to remember which private servers this client has joined
    function getJoinedServers() {
      try {
        const raw = localStorage.getItem('joined_servers');
        return raw ? JSON.parse(raw) : [];
      } catch (e) {
        return [];
      }
    }
    function markJoinedServer(serverId) {
      const arr = getJoinedServers();
      if (!arr.includes(serverId)) {
        arr.push(serverId);
        localStorage.setItem('joined_servers', JSON.stringify(arr));
        // refresh UI so the newly-joined private server appears in the left list
        refreshServersUI();
      }
    }
    function unmarkJoinedServer(serverId) {
      const arr = getJoinedServers();
      const idx = arr.indexOf(serverId);
      if (idx !== -1) {
        arr.splice(idx,1);
        localStorage.setItem('joined_servers', JSON.stringify(arr));
        // refresh UI so the left list updates immediately
        refreshServersUI();
      }
    }
    function hasJoinedServer(serverId) {
      if (isAdminLocal()) return true; // admins always allowed
      const arr = getJoinedServers();
      return arr.includes(serverId);
    }

    // refresh servers UI helper (reads DB and re-renders)
    function refreshServersUI() {
      db.ref(SERVERS_ROOT).once('value').then(snap => {
        renderServers(snap.val() || {});
      }).catch(()=>{});
    }

    // presence
    let presenceRef = null;
    let heartbeatTimer = null;
    function startPresence(uid, username, isAdmin=false) {
      presenceRef = db.ref(`${PRESENCE_ROOT}/${uid}`);
      presenceRef.set({ username, online: true, lastSeen: now(), isAdmin }).catch(()=>{});
      presenceRef.onDisconnect().remove().catch(()=>{});
      if (heartbeatTimer) clearInterval(heartbeatTimer);
      heartbeatTimer = setInterval(()=> {
        db.ref(`${PRESENCE_ROOT}/${uid}`).update({ lastSeen: now(), online: true, username, isAdmin }).catch(()=>{});
      }, 25000);
    }

    // servers
    function startServersListener() {
      serversRef = db.ref(SERVERS_ROOT);
      serversRef.on('value', snap => {
        const val = snap.val() || {};
        renderServers(val);
        if (!currentServerId) {
          // pick a visible server for this user (public or joined or created)
          const keys = Object.keys(val);
          for (let k of keys) {
            const info = val[k] || {};
            if (!info.isPrivate || hasJoinedServer(k) || info.createdBy === currentUser().uid || isAdminLocal()) {
              selectServer(k);
              break;
            }
          }
          // if none found, create default
          if (!currentServerId) createDefaultServerIfMissing();
        }
        refreshPublicJoinList(val);
      }, err => console.error('servers listen error', err));
    }

    async function createDefaultServerIfMissing() {
      const snap = await db.ref(SERVERS_ROOT).once('value');
      if (!snap.exists()) {
        const id = db.ref(SERVERS_ROOT).push().key;
        await db.ref(`${SERVERS_ROOT}/${id}`).set({ name: 'Global', createdBy: 'system', createdAt: now(), isPrivate: false });
      }
    }

    function renderServers(obj) {
      serverListEl.innerHTML = '';
      const entries = Object.entries(obj || {});
      entries.sort((a,b) => (a[1].createdAt || 0) - (b[1].createdAt || 0));
      entries.forEach(([id, info]) => {
        // filter: private servers are only shown if user joined them, or created them, or is admin
        if (info.isPrivate && !hasJoinedServer(id) && info.createdBy !== currentUser().uid && !isAdminLocal()) {
          return; // skip rendering this private server
        }

        const wrap = document.createElement('div');
        wrap.style.display = 'flex';
        wrap.style.flexDirection = 'column';
        wrap.style.alignItems = 'center';
        wrap.style.width = '100%';

        const el = document.createElement('div');
        el.className = 'server';
        el.dataset.serverId = id;
        el.title = info.name || id;
        el.innerHTML = `<div class="label">${(info.name||'S').slice(0,2).toUpperCase()}</div>`;
        if (id === currentServerId) el.classList.add('active');

        el.addEventListener('click', () => selectServer(id));

        // custom context menu on right-click
        el.addEventListener('contextmenu', (ev) => {
          ev.preventDefault();
          lastContextServerId = id;
          showServerContextMenu(ev.clientX, ev.clientY, id, info);
        });

        const nameEl = document.createElement('div');
        nameEl.className = 'server-name';
        nameEl.textContent = info.name || 'Server';

        wrap.appendChild(el);
        wrap.appendChild(nameEl);
        serverListEl.appendChild(wrap);
      });
    }

    // context menu logic
    function showServerContextMenu(x, y, serverId, info) {
      serverContextMenu.innerHTML = '';
      serverContextMenu.style.left = x + 'px';
      serverContextMenu.style.top = y + 'px';
      serverContextMenu.style.display = 'block';
      serverContextMenu.setAttribute('aria-hidden','false');

      // If user is admin, show Delete option
      if (isAdminLocal()) {
        const delBtn = document.createElement('button');
        delBtn.textContent = 'Delete Server';
        delBtn.addEventListener('click', async () => {
          serverContextMenu.style.display = 'none';
          const confirmDelete = confirm(`Delete server "${info.name}"? This removes its messages and cannot be undone.`);
          if (!confirmDelete) return;
          await db.ref(`${SERVERS_ROOT}/${serverId}`).remove().catch(()=>{});
          await db.ref(`${MESSAGES_ROOT}/${serverId}`).remove().catch(()=>{});
          showBanner('Server deleted');
          if (currentServerId === serverId) currentServerId = null;
          // refresh UI after deletion
          refreshServersUI();
        });
        serverContextMenu.appendChild(delBtn);
      }

      // If server is private and user has joined, show Leave option (not for creator)
      if (info.isPrivate && hasJoinedServer(serverId) && info.createdBy !== currentUser().uid) {
        const leaveBtn = document.createElement('button');
        leaveBtn.textContent = 'Leave Server';
        leaveBtn.addEventListener('click', () => {
          serverContextMenu.style.display = 'none';
          const ok = confirm(`Leave private server "${info.name}"? You will need the password to rejoin.`);
          if (!ok) return;
          unmarkJoinedServer(serverId);
          showBanner('Left server');
          if (currentServerId === serverId) {
            currentServerId = null;
            db.ref(SERVERS_ROOT).once('value').then(snap => {
              const servers = snap.val() || {};
              for (let k in servers) {
                const s = servers[k];
                if (!s.isPrivate || hasJoinedServer(k) || s.createdBy === currentUser().uid || isAdminLocal()) {
                  selectServer(k);
                  return;
                }
              }
              chatEl.innerHTML = '';
              document.getElementById('currentServerTitle').textContent = 'No server';
              document.getElementById('currentServerSubtitle').textContent = '';
            }).catch(()=>{});
          }
        });
        serverContextMenu.appendChild(leaveBtn);
      }

      // If user created the private server, show owner note
      if (info.isPrivate && info.createdBy === currentUser().uid) {
        const ownerNote = document.createElement('button');
        ownerNote.textContent = 'You are owner';
        ownerNote.disabled = true;
        serverContextMenu.appendChild(ownerNote);
      }

      if (serverContextMenu.children.length === 0) {
        const closeBtn = document.createElement('button');
        closeBtn.textContent = 'Close';
        closeBtn.addEventListener('click', () => { serverContextMenu.style.display = 'none'; });
        serverContextMenu.appendChild(closeBtn);
      }
    }

    // hide context menu on click elsewhere
    document.addEventListener('click', (e) => {
      if (serverContextMenu.style.display === 'block') {
        serverContextMenu.style.display = 'none';
        serverContextMenu.setAttribute('aria-hidden','true');
      }
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        serverContextMenu.style.display = 'none';
        serverContextMenu.setAttribute('aria-hidden','true');
      }
    });

    // Select server with private-check and local join memory
    async function selectServer(id) {
      if (!id) return;
      if (currentServerId === id) return;

      // fetch server info to check privacy
      let info = null;
      try {
        const snap = await db.ref(`${SERVERS_ROOT}/${id}`).once('value');
        info = snap.val() || {};
      } catch (err) {
        console.error('Failed to read server info', err);
        showBanner('Failed to select server');
        return;
      }

      // If server is private and user hasn't joined it yet, require password (unless admin or creator)
      if (info.isPrivate && !hasJoinedServer(id) && info.createdBy !== currentUser().uid) {
        if (isAdminLocal()) {
          markJoinedServer(id);
        } else {
          const pw = prompt(`Server "${info.name || id}" is private. Enter password to join:`);
          if (pw === null) return;
          if (pw !== (info.password || '')) {
            showBanner('Incorrect server password');
            return;
          }
          markJoinedServer(id);
        }
      }

      if (messagesRef) messagesRef.off();

      currentServerId = id;

      try {
        document.getElementById('currentServerTitle').textContent = 'Server: ' + (info.name || id);
        document.getElementById('currentServerSubtitle').textContent = info.isPrivate ? 'Private server' : 'Public server';
      } catch (e) {}

      document.querySelectorAll('.server').forEach(s => s.classList.toggle('active', s.dataset.serverId === id));

      startMessagesForServer(id);
    }

    // create/join modal UI
    tabCreate.addEventListener('click', () => { tabCreate.classList.add('active'); tabJoin.classList.remove('active'); createPane.style.display='block'; joinPane.style.display='none'; });
    tabJoin.addEventListener('click', () => { tabJoin.classList.add('active'); tabCreate.classList.remove('active'); createPane.style.display='none'; joinPane.style.display='block'; refreshPublicJoinList(); });

    // show modal (plus button)
    createServerBtn.addEventListener('click', () => {
      createServerError.style.display = 'none';
      joinError.style.display = 'none';
      tabCreate.click();
      createJoinModal.style.display = 'flex';
      newServerName.focus();
    });

    // Create server: show/hide password row
    document.querySelectorAll('input[name="serverType"]').forEach(r => r.addEventListener('change', (e) => {
      privatePasswordRow.style.display = (e.target.value === 'private') ? 'block' : 'none';
    }));

    createServerCancel.addEventListener('click', () => createJoinModal.style.display = 'none');

    createServerSubmit.addEventListener('click', async () => {
      createServerError.style.display = 'none';
      const name = (newServerName.value || '').trim();
      const type = document.querySelector('input[name="serverType"]:checked')?.value || 'public';
      const isPrivate = (type === 'private');
      const password = (newServerPassword.value || '').trim();

      if (!name) { createServerError.textContent = 'Enter a server name'; createServerError.style.display = 'block'; return; }
      if (isPrivate && !password) { createServerError.textContent = 'Enter a password for private server'; createServerError.style.display = 'block'; return; }
      if (!isAdminLocal()) { createServerError.textContent = 'Admins only'; createServerError.style.display      serverContextMenu.style.display = 'block';
      serverContextMenu.setAttribute('aria-hidden','false');

      // If user is admin, show Delete option
      if (isAdminLocal()) {
        const delBtn = document.createElement('button');
        delBtn.textContent = 'Delete Server';
        delBtn.addEventListener('click', async () => {
          serverContextMenu.style.display = 'none';
          const confirmDelete = confirm(`Delete server "${info.name}"? This removes its messages and cannot be undone.`);
          if (!confirmDelete) return;
          await db.ref(`${SERVERS_ROOT}/${serverId}`).remove().catch(()=>{});
          await db.ref(`${MESSAGES_ROOT}/${serverId}`).remove().catch(()=>{});
          showBanner('Server deleted');
          if (currentServerId === serverId) currentServerId = null;
          // refresh UI after deletion
          refreshServersUI();
        });
        serverContextMenu.appendChild(delBtn);
      }

      // If server is private and user has joined, show Leave option (not for creator)
      if (info.isPrivate && hasJoinedServer(serverId) && info.createdBy !== currentUser().uid) {
        const leaveBtn = document.createElement('button');
        leaveBtn.textContent = 'Leave Server';
        leaveBtn.addEventListener('click', () => {
          serverContextMenu.style.display = 'none';
          const ok = confirm(`Leave private server "${info.name}"? You will need the password to rejoin.`);
          if (!ok) return;
          unmarkJoinedServer(serverId);
          showBanner('Left server');
          if (currentServerId === serverId) {
            currentServerId = null;
            db.ref(SERVERS_ROOT).once('value').then(snap => {
              const servers = snap.val() || {};
              for (let k in servers) {
                const s = servers[k];
                if (!s.isPrivate || hasJoinedServer(k) || s.createdBy === currentUser().uid || isAdminLocal()) {
                  selectServer(k);
                  return;
                }
              }
              chatEl.innerHTML = '';
              document.getElementById('currentServerTitle').textContent = 'No server';
              document.getElementById('currentServerSubtitle').textContent = '';
            }).catch(()=>{});
          }
        });
        serverContextMenu.appendChild(leaveBtn);
      }

      // If user created the private server, show owner note
      if (info.isPrivate && info.createdBy === currentUser().uid) {
        const ownerNote = document.createElement('button');
        ownerNote.textContent = 'You are owner';
        ownerNote.disabled = true;
        serverContextMenu.appendChild(ownerNote);
      }

      if (serverContextMenu.children.length === 0) {
        const closeBtn = document.createElement('button');
        closeBtn.textContent = 'Close';
        closeBtn.addEventListener('click', () => { serverContextMenu.style.display = 'none'; });
        serverContextMenu.appendChild(closeBtn);
      }
    }

    // hide context menu on click elsewhere
    document.addEventListener('click', (e) => {
      if (serverContextMenu.style.display === 'block') {
        serverContextMenu.style.display = 'none';
        serverContextMenu.setAttribute('aria-hidden','true');
      }
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        serverContextMenu.style.display = 'none';
        serverContextMenu.setAttribute('aria-hidden','true');
      }
    });

    // Select server with private-check and local join memory
    async function selectServer(id) {
      if (!id) return;
      if (currentServerId === id) return;

      // fetch server info to check privacy
      let info = null;
      try {
        const snap = await db.ref(`${SERVERS_ROOT}/${id}`).once('value');
        info = snap.val() || {};
      } catch (err) {
        console.error('Failed to read server info', err);
        showBanner('Failed to select server');
        return;
      }

      // If server is private and user hasn't joined it yet, require password (unless admin or creator)
      if (info.isPrivate && !hasJoinedServer(id) && info.createdBy !== currentUser().uid) {
        if (isAdminLocal()) {
          markJoinedServer(id);
        } else {
          const pw = prompt(`Server "${info.name || id}" is private. Enter password to join:`);
          if (pw === null) return;
          if (pw !== (info.password || '')) {
            showBanner('Incorrect server password');
            return;
          }
          markJoinedServer(id);
        }
      }

      if (messagesRef) messagesRef.off();

      currentServerId = id;

      try {
        document.getElementById('currentServerTitle').textContent = 'Server: ' + (info.name || id);
        document.getElementById('currentServerSubtitle').textContent = info.isPrivate ? 'Private server' : 'Public server';
      } catch (e) {}

      document.querySelectorAll('.server').forEach(s => s.classList.toggle('active', s.dataset.serverId === id));

      startMessagesForServer(id);
    }

    // create/join modal UI
    tabCreate.addEventListener('click', () => { tabCreate.classList.add('active'); tabJoin.classList.remove('active'); createPane.style.display='block'; joinPane.style.display='none'; });
    tabJoin.addEventListener('click', () => { tabJoin.classList.add('active'); tabCreate.classList.remove('active'); createPane.style.display='none'; joinPane.style.display='block'; refreshPublicJoinList(); });

    // show modal (plus button)
    createServerBtn.addEventListener('click', () => {
      createServerError.style.display = 'none';
      joinError.style.display = 'none';
      tabCreate.click();
      createJoinModal.style.display = 'flex';
      newServerName.focus();
    });

    // Create server: show/hide password row
    document.querySelectorAll('input[name="serverType"]').forEach(r => r.addEventListener('change', (e) => {
      privatePasswordRow.style.display = (e.target.value === 'private') ? 'block' : 'none';
    }));

    createServerCancel.addEventListener('click', () => createJoinModal.style.display = 'none');

    createServerSubmit.addEventListener('click', async () => {
      createServerError.style.display = 'none';
      const name = (newServerName.value || '').trim();
      const type = document.querySelector('input[name="serverType"]:checked')?.value || 'public';
      const isPrivate = (type === 'private');
      const password = (newServerPassword.value || '').trim();

      if (!name) { createServerError.textContent = 'Enter a server name'; createServerError.style.display = 'block'; return; }
      if (isPrivate && !password) { createServerError.textContent = 'Enter a password for private server'; createServerError.style.display = 'block'; return; }
      if (!isAdminLocal()) { createServerError.textContent = 'Admins only'; createServerError.style.display = 'block'; return; }

      try {
        const id = db.ref(SERVERS_ROOT).push().key;
        const me = currentUser();
        await db.ref(`${SERVERS_ROOT}/${id}`).set({
          name,
          createdBy: me.uid,
          createdAt: now(),
          isPrivate: !!isPrivate,
          password: isPrivate ? password : null
        });
        if (isPrivate) markJoinedServer(id);
        createJoinModal.style.display = 'none';
        showBanner('Server created');
        // refresh servers so creator sees it immediately
        refreshServersUI();
        selectServer(id);
      } catch (err) {
        console.error('create server error', err);
        createServerError.textContent = 'Create failed';
        createServerError.style.display = 'block';
      }
    });

    // Refresh public join list (public servers only)
    async function refreshPublicJoinList(snapshotVal) {
      publicJoinList.innerHTML = '';
      let servers = snapshotVal;
      if (!servers) {
        const snap = await db.ref(SERVERS_ROOT).once('value');
        servers = snap.val() || {};
      }
      const entries = Object.entries(servers);
      entries.sort((a,b) => (a[1].createdAt||0) - (b[1].createdAt||0));
      entries.forEach(([id, info]) => {
        if (info.isPrivate) return; // do not list private servers
        const row = document.createElement('div');
        row.className = 'server-row';
        const left = document.createElement('div');
        left.style.display = 'flex';
        left.style.alignItems = 'center';
        const title = document.createElement('div');
        title.textContent = info.name || id;
        title.style.fontWeight = '600';
        left.appendChild(title);
        const right = document.createElement('div');
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.textContent = 'Join';
        btn.style.background = '#4f46e5';
        btn.style.color = '#fff';
        btn.addEventListener('click', () => {
          selectServer(id);
          createJoinModal.style.display = 'none';
          showBanner('Joined server');
        });
        right.appendChild(btn);
        row.appendChild(left);
        row.appendChild(right);
        publicJoinList.appendChild(row);
      });
    }

    // Join private by name & password
    joinPrivateSubmit.addEventListener('click', async () => {
      joinError.style.display = 'none';
      const name = (joinServerName.value || '').trim();
      const pw = (joinServerPassword.value || '').trim();
      if (!name || !pw) { joinError.textContent = 'Enter server name and password'; joinError.style.display = 'block'; return; }

      try {
        const snap = await db.ref(SERVERS_ROOT).orderByChild('name').equalTo(name).once('value');
        const val = snap.val();
        if (!val) {
          joinError.textContent = 'Server not found';
          joinError.style.display = 'block';
          return;
        }
        // find matching server (name exact). There may be multiple; pick first that is private.
        const entries = Object.entries(val);
        let matched = null;
        for (const [id, info] of entries) {
          if (info.isPrivate) { matched = { id, info }; break; }
        }
        if (!matched) {
          joinError.textContent = 'No private server with that name';
          joinError.style.display = 'block';
          return;
        }
        const { id, info } = matched;
        if (pw !== (info.password || '')) {
          joinError.textContent = 'Incorrect password';
          joinError.style.display = 'block';
          return;
        }
        markJoinedServer(id);
        // ensure UI updates so server appears in left list
        refreshServersUI();
        selectServer(id);
        createJoinModal.style.display = 'none';
        joinServerName.value = '';
        joinServerPassword.value = '';
        showBanner('Joined private server');
      } catch (err) {
        console.error('join private error', err);
        joinError.textContent = 'Join failed';
        joinError.style.display = 'block';
      }
    });

    joinClose.addEventListener('click', () => createJoinModal.style.display = 'none');

    // messages per-server
    function startMessagesForServer(serverId) {
      chatEl.innerHTML = '';
      messagesRef = db.ref(`${MESSAGES_ROOT}/${serverId}`);
      messagesRef.limitToLast(500).on('child_added', snap => {
        appendChatMessage(snap.val());
      }, err => appendSystemMessage('Listen error: ' + (err && err.message ? err.message : err)));
    }

    function appendSystemMessage(text) {
      const el = document.createElement('div');
      el.className = 'msg';
      el.style.opacity = '0.9';
      el.textContent = text;
      chatEl.appendChild(el);
      chatEl.scrollTop = chatEl.scrollHeight;
    }
    function appendChatMessage(data) {
      const el = document.createElement('div');
      el.className = 'msg';
      const meta = document.createElement('div');
      meta.className = 'meta';
      const nameSpan = document.createElement('span');
      nameSpan.textContent = data.name || 'Guest';
      meta.appendChild(nameSpan);

      if (data.isAdmin) {
        const badge = document.createElement('span');
        badge.className = 'admin-badge';
        badge.textContent = 'ADMIN';
        meta.appendChild(badge);
      }

      const timeSpan = document.createElement('span');
      timeSpan.style.marginLeft = '8px';
      timeSpan.style.color = 'var(--muted)';
      timeSpan.textContent = '• ' + new Date(data.ts || Date.now()).toLocaleTimeString();
      meta.appendChild(timeSpan);

      const body = document.createElement('div');
      body.textContent = data.text || '';
      el.appendChild(meta);
      el.appendChild(body);
      chatEl.appendChild(el);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    // send message (to current server)
    sendBtn.addEventListener('click', sendMessage);
    msgInput.addEventListener('keydown', e => { if (e.key === 'Enter') sendMessage(); });

    function sendMessage() {
      if (!currentServerId) { showBanner('Select a server first'); return; }
      if (isKickedThisSession()) { showBanner('You are kicked this session'); return; }
      if (isBannedLocal()) { showBanner('You are banned'); return; }
      const raw = msgInput.value || '';
      const text = raw.replace(/\r?\n|\r/g,' ').trim().slice(0,300);
      if (!text) return;
      const u = currentUser();
      const isAdmin = !!u.isAdmin;
      db.ref(`${MESSAGES_ROOT}/${currentServerId}`).push({ name: u.username, text, ts: now(), uid: u.uid, isAdmin }).then(()=> {
        msgInput.value = '';
      }).catch(err => {
        console.error('push error', err);
        appendSystemMessage('Send failed: ' + (err && err.message ? err.message : err));
      });
    }

    // members list (presence)
    let presenceListener = null;
    function startMembersListener() {
      const ref = db.ref(PRESENCE_ROOT);
      presenceListener = ref;
      ref.on('value', snap => {
        const val = snap.val() || {};
        renderMembers(val);
      }, err => console.error('presence listen error', err));
    }
    function renderMembers(obj) {
      membersListEl.innerHTML = '';
      const entries = Object.entries(obj || {});
      entries.sort((a,b) => {
        const A = a[1]||{}, B = b[1]||{};
        const aOnline = A.online ? 1 : 0, bOnline = B.online ? 1 : 0;
        if (aOnline !== bOnline) return bOnline - aOnline;
        return (B.lastSeen||0) - (A.lastSeen||0);
      });
      entries.forEach(([uid, info]) => {
        const member = document.createElement('div');
        member.className = 'member';
        member.dataset.uid = uid;
        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        avatar.textContent = (info.username || 'U').slice(0,2).toUpperCase();
        const infoWrap = document.createElement('div');
        infoWrap.className = 'info';
        const name = document.createElement('div');
        name.className = 'name';
        name.textContent = info.username || uid;
        if (info.isAdmin) {
          const adminTag = document.createElement('span');
          adminTag.className = 'admin-badge';
          adminTag.textContent = 'ADMIN';
          adminTag.style.marginLeft = '8px';
          name.appendChild(adminTag);
        }
        const status = document.createElement('div');
        status.className = 'status';
        status.textContent = info.online ? 'online' : 'last seen ' + timeAgo(info.lastSeen || Date.now());
        infoWrap.appendChild(name);
        infoWrap.appendChild(status);
        member.appendChild(avatar);
        member.appendChild(infoWrap);

        member.addEventListener('click', () => openMemberModal(uid, info));
        membersListEl.appendChild(member);
      });
      onlineCountEl.textContent = entries.length + ' online';
    }

    function timeAgo(ts) {
      const s = Math.floor((Date.now() - ts) / 1000);
      if (s < 10) return 'just now';
      if (s < 60) return s + 's';
      const m = Math.floor(s/60);
      if (m < 60) return m + 'm';
      const h = Math.floor(m/60);
      return h + 'h';
    }

    // member modal actions (kick/ban)
    let modalTargetUid = null;
    function openMemberModal(uid, info) {
      modalTargetUid = uid;
      modalName.textContent = info.username || uid;
      modalUid.textContent = uid;
      modalStatus.textContent = info.online ? 'online' : 'offline';
      if (isAdminLocal()) {
        kickBtn.style.display = 'inline-block';
        banBtn.style.display = 'inline-block';
      } else {
        kickBtn.style.display = 'none';
        banBtn.style.display = 'none';
      }
      memberModal.style.display = 'flex';
    }
    closeModal.addEventListener('click', ()=> memberModal.style.display = 'none');

    kickBtn.addEventListener('click', async () => {
      if (!modalTargetUid) return;
      const u = currentUser();
      if (!isAdminLocal()) { showBanner('Admin only'); return; }
      try {
        const ttl = 30_000; // 30 seconds
        await db.ref(`${KICKS_ROOT}/${modalTargetUid}`).set({ ts: now(), by: u.uid, byName: u.username, ttl });
        showBanner('Kick sent (30s)');
      } catch (err) {
        console.error('kick error', err);
        showBanner('Kick failed');
      }
      memberModal.style.display = 'none';
    });

    banBtn.addEventListener('click', async () => {
      if (!modalTargetUid) return;
      const u = currentUser();
      if (!isAdminLocal()) { showBanner('Admin only'); return; }
      try {
        const targetName = document.querySelector(`.member[data-uid="${modalTargetUid}"] .name`)?.textContent || modalTargetUid;
        await db.ref(`${BANS_ROOT}/${modalTargetUid}`).set({ ts: now(), by: u.uid, byName: u.username, username: targetName });
        showBanner('Ban applied');
      } catch (err) {
        console.error('ban error', err);
        showBanner('Ban failed');
      }
      memberModal.style.display = 'none';
    });

    // kicks & bans listeners
    function startKickListener() {
      const ref = db.ref(KICKS_ROOT);
      ref.on('child_added', snap => {
        const targetUid = snap.key;
        const data = snap.val() || {};
        const me = currentUser();
        if (me && me.uid === targetUid) {
          const expiry = (data.ts || now()) + (data.ttl || 30000);
          localStorage.setItem(`kicked_${me.uid}`, String(expiry));
          showKicked();
        }
        if (data && data.ttl && data.ts) {
          const removeAt = data.ts + data.ttl;
          const delay = Math.max(0, removeAt - now());
          setTimeout(()=> db.ref(`${KICKS_ROOT}/${targetUid}`).remove().catch(()=>{}), delay + 500);
        }
      });
      ref.on('child_removed', snap => {
        const targetUid = snap.key;
        localStorage.removeItem(`kicked_${targetUid}`);
        const me = currentUser();
        if (me && me.uid === targetUid) hideKicked();
      });
    }

    function startBanListener() {
      const ref = db.ref(BANS_ROOT);
      ref.on('child_added', snap => {
        const targetUid = snap.key;
        const data = snap.val() || {};
        localStorage.setItem(`banned_${targetUid}`, JSON.stringify({ ts: data.ts || now(), by: data.by || null, byName: data.byName || null, username: data.username || null }));
        const me = currentUser();
        if (me && me.uid === targetUid) showBanned();
        refreshBanland();
      });
      ref.on('child_removed', snap => {
        const targetUid = snap.key;
        localStorage.removeItem(`banned_${targetUid}`);
        const me = currentUser();
        if (me && me.uid === targetUid) hideBanned();
        refreshBanland();
      });
    }

    // kicked/banned UI helpers
    function showKicked() { kickedScreen.style.display = 'flex'; }
    function hideKicked() { kickedScreen.style.display = 'none'; }
    function isKickedThisSession() {
      const me = currentUser();
      const val = localStorage.getItem(`kicked_${me.uid}`);
      if (!val) return false;
      const expiry = Number(val);
      if (isNaN(expiry)) return true;
      if (Date.now() > expiry) {
        localStorage.removeItem(`kicked_${me.uid}`);
        hideKicked();
        db.ref(`${KICKS_ROOT}/${me.uid}`).remove().catch(()=>{});
        return false;
      }
      return true;
    }

    function showBanned() { bannedScreen.style.display = 'flex'; }
    function hideBanned() { bannedScreen.style.display = 'none'; }
    function isBannedLocal() { return !!localStorage.getItem(`banned_${currentUser().uid}`); }

    // Banland
    banlandBtn?.addEventListener('click', openBanland);
    closeBanland.addEventListener('click', ()=> banlandModal.style.display = 'none');

    async function openBanland() {
      if (!isAdminLocal()) { showBanner('Admin only'); return; }
      await refreshBanland();
      banlandModal.style.display = 'flex';
    }

    async function refreshBanland() {
      const snap = await db.ref(BANS_ROOT).once('value');
      const bans = snap.val() || {};
      banListEl.innerHTML = '';
      const entries = Object.entries(bans);
      if (entries.length === 0) {
        banListEl.textContent = 'No banned users';
        return;
      }
      entries.forEach(([uid, info]) => {
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.justifyContent = 'space-between';
        row.style.alignItems = 'center';
        row.style.padding = '8px 0';
        const left = document.createElement('div');
        left.textContent = (info.username || uid) + ' • ' + uid;
        const btn = document.createElement('button');
        btn.textContent = 'Unban';
        btn.className = 'btn';
        btn.style.background = '#10b981';
        btn.style.color = '#fff';
        btn.addEventListener('click', () => {
          db.ref(`${BANS_ROOT}/${uid}`).remove().then(()=> showBanner('Unbanned')).catch(()=> showBanner('Unban failed'));
        });
        row.appendChild(left);
        row.appendChild(btn);
        banListEl.appendChild(row);
      });
    }

    // Admin login flow (local-only)
    adminLoginBtn.addEventListener('click', () => {
      adminError.style.display = 'none';
      adminUser.value = '';
      adminPass.value = '';
      adminModal.style.display = 'flex';
      adminUser.focus();
    });
    adminCancel.addEventListener('click', () => adminModal.style.display = 'none');

    adminSubmit.addEventListener('click', () => {
      const u = (adminUser.value || '').trim();
      const p = (adminPass.value || '').trim();
      if (u === ADMIN_USERNAME && p === ADMIN_PASSWORD) {
        const me = currentUser();
        me.username = ADMIN_USERNAME;
        me.isAdmin = true;
        saveUser(me);
        localStorage.setItem('admin_logged_in', '1');
        db.ref(`${PRESENCE_ROOT}/${me.uid}`).update({ username: me.username, isAdmin: true }).catch(()=>{});
        updateAdminUI();
        adminModal.style.display = 'none';
        showBanner('Logged in as admin');
        // refresh servers so admin sees private servers immediately
        refreshServersUI();
      } else {
        adminError.textContent = 'Invalid credentials';
        adminError.style.display = 'block';
      }
    });

    // Admin logout
    adminLogoutBtn.addEventListener('click', () => {
      const me = currentUser();
      me.isAdmin = false;
      saveUser(me);
      localStorage.removeItem('admin_logged_in');
      db.ref(`${PRESENCE_ROOT}/${me.uid}`).update({ isAdmin: false }).catch(()=>{});
      updateAdminUI();
      showBanner('Admin logged out');
      // refresh servers so private servers hide if needed
      refreshServersUI();
    });

    // init
    (function init() {
      const u = currentUser();
      if (localStorage.getItem('admin_logged_in') === '1' && u.username === ADMIN_USERNAME) u.isAdmin = true;
      saveUser(u);
      displayNameInput.value = u.username || '';
      updateAdminUI();
      startPresence(u.uid, u.username, !!u.isAdmin);
      startServersListener();
      startMembersListener();
      startKickListener();
      startBanListener();

      db.ref(`${KICKS_ROOT}/${u.uid}`).once('value').then(snap => {
        const data = snap.val();
        if (!data) {
          localStorage.removeItem(`kicked_${u.uid}`);
          hideKicked();
        } else {
          const expiry = (data.ts || now()) + (data.ttl || 30000);
          localStorage.setItem(`kicked_${u.uid}`, String(expiry));
          if (Date.now() > expiry) {
            db.ref(`${KICKS_ROOT}/${u.uid}`).remove().catch(()=>{});
            localStorage.removeItem(`kicked_${u.uid}`);
            hideKicked();
          } else {
            showKicked();
            setTimeout(()=> db.ref(`${KICKS_ROOT}/${u.uid}`).remove().catch(()=>{}), expiry - Date.now() + 500);
          }
        }
      }).catch(()=>{});

      if (isBannedLocal()) showBanned();
      appendSystemMessage('You are signed in as ' + u.username + (isAdminLocal() ? ' (admin)' : ''));
    })();

    // displayName change
    displayNameInput.addEventListener('change', () => {
      const name = (displayNameInput.value || '').trim() || currentUser().username;
      setUserName(name);
    });

    // remove presence on unload
    window.addEventListener('beforeunload', () => {
      const u = currentUser();
      if (u && u.uid) db.ref(`${PRESENCE_ROOT}/${u.uid}`).remove().catch(()=>{});
    });

    // Alt+X opens Banland
    window.addEventListener('keydown', (e) => {
      if (e.altKey && (e.key === 'x' || e.key === 'X')) {
        openBanland();
      }
    });

    // close modals on outside click
    createJoinModal.addEventListener('click', (ev) => { if (ev.target === createJoinModal) createJoinModal.style.display = 'none'; });
    adminModal.addEventListener('click', (ev) => { if (ev.target === adminModal) adminModal.style.display = 'none'; });
    memberModal.addEventListener('click', (ev) => { if (ev.target === memberModal) memberModal.style.display = 'none'; });
    banlandModal.addEventListener('click', (ev) => { if (ev.target === banlandModal) banlandModal.style.display = 'none'; });

    // expose helpers for debugging
    window.__chatHelpers = { currentUser, isAdminLocal, isBannedLocal, isKickedThisSession, showBanner, selectServer, refreshPublicJoinList, getJoinedServers, refreshServersUI };
  </script>
</body>
</html>
