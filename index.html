<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Live Chat (with uploads)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{
      --bg:#f2f6fb;
      --card:#ffffff;
      --muted:#7b8794;
      --accent:#4f46e5;
      --you:#e9f0ff;
      --other:#ffffff;
      --shadow: 0 6px 20px rgba(20,30,60,0.08);
      --radius:12px;
      --max-width:760px;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#eef6ff 0%,var(--bg) 100%);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:#0f1724}
    .wrap{max-width:var(--max-width);margin:28px auto;padding:18px;box-sizing:border-box}
    .card{background:var(--card);border-radius:16px;box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column;height:78vh;min-height:520px}
    header{display:flex;align-items:center;gap:12px;padding:14px 18px;border-bottom:1px solid #eef2f7}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#06b6d4);display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
    header h1{font-size:16px;margin:0}
    header p{margin:0;color:var(--muted);font-size:13px}
    #chat{flex:1;padding:18px;overflow:auto;display:flex;flex-direction:column;gap:10px;background:linear-gradient(180deg,rgba(79,70,229,0.02),transparent)}
    .msg-row{display:flex;gap:10px;align-items:flex-end;max-width:85%}
    .msg-row.you{margin-left:auto;flex-direction:row-reverse}
    .avatar{width:36px;height:36px;border-radius:10px;background:#c7d2fe;color:#1e293b;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:14px;flex-shrink:0}
    .bubble{padding:10px 12px;border-radius:12px;background:var(--other);box-shadow:0 1px 0 rgba(15,23,36,0.03);position:relative;word-break:break-word}
    .msg-row.you .bubble{background:var(--you)}
    .meta{display:flex;gap:8px;align-items:center;margin-top:6px;font-size:12px;color:var(--muted)}
    .time{font-size:11px;color:var(--muted)}
    .input-bar{display:flex;gap:10px;padding:12px;border-top:1px solid #eef2f7;background:linear-gradient(180deg,transparent,rgba(255,255,255,0.6));align-items:center}
    .input{flex:1;display:flex;gap:8px;align-items:center;background:#f8fafc;padding:8px;border-radius:10px;border:1px solid #eef2f7}
    .input input{flex:1;border:0;background:transparent;padding:8px;font-size:14px;outline:none}
    .send{background:var(--accent);color:white;border:0;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600;box-shadow:0 6px 18px rgba(79,70,229,0.12)}
    .send:active{transform:translateY(1px)}
    .attach{background:#10b981;color:white;border:0;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:600;box-shadow:0 6px 18px rgba(16,185,129,0.12)}
    .name{width:120px;padding:8px;border-radius:8px;border:1px solid #eef2f7;background:white}
    .muted-note{font-size:12px;color:var(--muted);padding:8px 18px}
    .progress { font-size:12px;color:var(--muted);padding:6px 10px;border-radius:8px;background:#fff;display:inline-block;margin-top:6px;box-shadow:0 1px 0 rgba(0,0,0,0.03) }
    img.msg-image{max-width:320px;border-radius:8px;display:block}
    .error-box{background:#fff6f6;border:1px solid #ffd6d6;color:#7b1d1d;padding:10px;border-radius:8px;margin:12px 18px;display:none}
    .help-box{background:#fffef6;border:1px solid #fff1b8;color:#6b4b00;padding:10px;border-radius:8px;margin:12px 18px;display:none;white-space:pre-wrap;font-family:monospace;font-size:13px}
    @media (max-width:640px){
      .name{display:none}
      .card{height:86vh}
      .logo{width:36px;height:36px}
      img.msg-image{max-width:220px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="application" aria-label="Chat">
      <header>
        <div class="logo">C</div>
        <div>
          <h1>Live Chat</h1>
          <p>Real-time messages powered by Firebase</p>
        </div>
      </header>

      <div id="chat" aria-live="polite"></div>

      <div class="muted-note">Tip: press Enter to send. Your name is saved locally. Attach images or files with the paperclip.</div>

      <div id="error" class="error-box" role="alert"></div>
      <div id="help" class="help-box" aria-hidden="true"></div>

      <div class="input-bar">
        <input id="name" class="name" type="text" placeholder="Your name" value="Guest" aria-label="Your name">
        <div class="input" role="group" aria-label="Message input">
          <input id="msg" type="text" placeholder="Write a message…" aria-label="Message">
        </div>
        <button id="attach" class="attach" aria-label="Attach file">Attach</button>
        <button id="send" class="send" aria-label="Send message">Send</button>
        <!-- hidden file input -->
        <input id="file" type="file" accept="image/*,video/*,application/pdf" style="display:none">
      </div>
    </div>
  </div>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <script>
    /* ====== CONFIG: paste your firebaseConfig here ====== */
    const firebaseConfig = {
      apiKey: "AIzaSyAulcwmA2r2Z0Wv5mxyuWwQvPv05E8HvMU",
      authDomain: "dwellicon-42e72.firebaseapp.com",
      databaseURL: "https://dwellicon-42e72-default-rtdb.firebaseio.com",
      projectId: "dwellicon-42e72",
      storageBucket: "dwellicon-42e72.appspot.com",
      messagingSenderId: "634657717896",
      appId: "1:634657717896:web:27f246614fdb2c2398a93d",
      measurementId: "G-GP1YBL86RB"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);

    // Services
    const db = firebase.database().ref('messages');
    const storageRoot = firebase.storage().ref();
    const auth = firebase.auth();

    // Elements
    const chat = document.getElementById('chat');
    const nameInput = document.getElementById('name');
    const msgInput = document.getElementById('msg');
    const sendBtn = document.getElementById('send');
    const attachBtn = document.getElementById('attach');
    const fileInput = document.getElementById('file');
    const errorBox = document.getElementById('error');
    const helpBox = document.getElementById('help');

    // Persist name
    const savedName = localStorage.getItem('chat_name');
    if (savedName) nameInput.value = savedName;
    nameInput.addEventListener('change', () => localStorage.setItem('chat_name', nameInput.value.trim()));

    // Anonymous auth (so uploads can be restricted to authenticated users)
    auth.onAuthStateChanged(user => {
      if (user) {
        console.log('signed in anonymously', user.uid);
      } else {
        auth.signInAnonymously().catch(err => {
          console.error('auth error', err);
          showError('Authentication failed. Uploads may not work.');
        });
      }
    });

    // Helpers
    function initials(name){
      return (name || 'G').split(' ').map(s=>s[0]).slice(0,2).join('').toUpperCase();
    }
    function timeFmt(ts){
      const d = new Date(ts);
      return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    }
    function showError(msg){
      errorBox.style.display = 'block';
      errorBox.textContent = msg;
    }
    function hideError(){
      errorBox.style.display = 'none';
      errorBox.textContent = '';
    }
    function showHelp(text){
      helpBox.style.display = 'block';
      helpBox.setAttribute('aria-hidden','false');
      helpBox.textContent = text;
    }
    function hideHelp(){
      helpBox.style.display = 'none';
      helpBox.setAttribute('aria-hidden','true');
      helpBox.textContent = '';
    }

    // Auto-scroll only if user is near bottom
    function isAtBottom(el, threshold = 80){
      return (el.scrollHeight - el.scrollTop - el.clientHeight) < threshold;
    }

    // Render message (supports text and image/file)
    function renderMessage(data, key){
      const me = (data.name || 'Guest') === (nameInput.value || 'Guest');
      const row = document.createElement('div');
      row.className = 'msg-row' + (me ? ' you' : '');
      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      avatar.textContent = initials(data.name);
      const bubbleWrap = document.createElement('div');
      bubbleWrap.style.display = 'flex';
      bubbleWrap.style.flexDirection = 'column';
      const bubble = document.createElement('div');
      bubble.className = 'bubble';

      // If message contains an image/file URL
      if (data.imageUrl) {
        const fileName = data.fileName || '';
        const lower = (fileName.split('.').pop() || '').toLowerCase();
        if (lower === 'pdf') {
          const link = document.createElement('a');
          link.href = data.imageUrl;
          link.textContent = fileName || 'PDF';
          link.target = '_blank';
          bubble.appendChild(link);
        } else if (/(mp4|webm|ogg)$/i.test(lower) || /video\//.test(data.contentType || '')) {
          const vid = document.createElement('video');
          vid.src = data.imageUrl;
          vid.controls = true;
          vid.style.maxWidth = '320px';
          bubble.appendChild(vid);
        } else {
          const img = document.createElement('img');
          img.className = 'msg-image';
          img.src = data.imageUrl;
          img.alt = fileName || 'image';
          img.addEventListener('click', () => window.open(data.imageUrl, '_blank'));
          bubble.appendChild(img);
        }
        if (data.text) {
          const caption = document.createElement('div');
          caption.style.marginTop = '8px';
          caption.textContent = data.text;
          bubble.appendChild(caption);
        }
      } else {
        bubble.textContent = data.text;
      }

      const meta = document.createElement('div');
      meta.className = 'meta';
      const nameEl = document.createElement('div');
      nameEl.style.fontSize='12px';
      nameEl.style.color='var(--muted)';
      nameEl.textContent = data.name || 'Guest';
      const timeEl = document.createElement('div');
      timeEl.className = 'time';
      timeEl.textContent = timeFmt(data.ts || Date.now());
      meta.appendChild(nameEl);
      meta.appendChild(timeEl);

      bubbleWrap.appendChild(bubble);
      bubbleWrap.appendChild(meta);
      row.appendChild(avatar);
      row.appendChild(bubbleWrap);

      const atBottom = isAtBottom(chat);
      chat.appendChild(row);
      if (atBottom) chat.scrollTop = chat.scrollHeight;
    }

    // Listen for messages
    db.limitToLast(200).on('child_added', snap => {
      const data = snap.val();
      renderMessage(data, snap.key);
    }, err => {
      console.error('listen error', err);
      showError('Realtime DB listen error: ' + (err && err.message ? err.message : String(err)));
    });

    // Send text message
    function sendText(){
      hideError();
      hideHelp();
      const raw = msgInput.value || '';
      const text = raw.replace(/\r?\n|\r/g,' ').trim().slice(0,300);
      const name = (nameInput.value || 'Guest').trim().slice(0,50) || 'Guest';
      if (!text) return;
      db.push({ name, text, ts: Date.now() })
        .then(()=> msgInput.value = '')
        .catch(e => {
          console.error('send error', e);
          showError('Send failed: ' + (e && e.message ? e.message : String(e)));
        });
    }

    sendBtn.addEventListener('click', sendText);
    msgInput.addEventListener('keydown', e => { if (e.key === 'Enter') sendText(); });

    // Attach flow
    attachBtn.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', async (e) => {
      hideError();
      hideHelp();
      const file = e.target.files[0];
      if (!file) return;

      // Validation
      const maxBytes = 5 * 1024 * 1024; // 5 MB
      const allowedPrefixes = ['image/', 'video/', 'application/pdf'];
      if (!allowedPrefixes.some(p => file.type.startsWith(p))) {
        showError('Unsupported file type. Allowed: images, videos, PDFs.');
        fileInput.value = '';
        return;
      }
      if (file.size > maxBytes) {
        showError('File too large (max 5 MB).');
        fileInput.value = '';
        return;
      }

      // Optional resize for images
      let uploadBlob = file;
      if (file.type.startsWith('image/')) {
        try {
          uploadBlob = await resizeImage(file, 1200);
        } catch (err) {
          console.warn('resize failed, uploading original', err);
          uploadBlob = file;
        }
      }

      // Create unique path
      const safeName = file.name.replace(/[^a-zA-Z0-9.\-_]/g, '_');
      const path = `uploads/${firebaseConfig.projectId}/${Date.now()}_${safeName}`;
      const fileRef = storageRoot.child(path);

      // Show progress element
      const progressEl = document.createElement('div');
      progressEl.className = 'progress';
      progressEl.textContent = `Uploading ${file.name} — 0%`;
      chat.appendChild(progressEl);
      chat.scrollTop = chat.scrollHeight;

      // Upload with error handling for CORS and permission issues
      const uploadTask = fileRef.put(uploadBlob, { contentType: file.type });
      uploadTask.on('state_changed', snapshot => {
        const pct = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
        progressEl.textContent = `Uploading ${file.name} — ${pct}%`;
      }, err => {
        console.error('upload error', err);
        progressEl.textContent = 'Upload failed';
        setTimeout(() => progressEl.remove(), 3000);

        // Detect CORS preflight failure (common when bucket CORS not configured)
        if (err && err.code && (err.code === 'storage/unauthorized' || err.code === 'storage/unknown')) {
          showError('Upload blocked by CORS or permission error. See instructions below to fix bucket CORS.');
          showCorsInstructions();
        } else {
          showError('Upload failed: ' + (err && err.message ? err.message : String(err)));
        }
      }, async () => {
        try {
          const url = await fileRef.getDownloadURL();
          progressEl.remove();
          const name = (nameInput.value || 'Guest').trim().slice(0,50) || 'Guest';
          db.push({
            name,
            text: '', // optional caption could be added
            imageUrl: url,
            fileName: file.name,
            contentType: file.type,
            ts: Date.now()
          }).catch(e => {
            console.error('push error', e);
            showError('Failed to post message: ' + (e && e.message ? e.message : String(e)));
          });
        } catch (err) {
          console.error('getDownloadURL error', err);
          progressEl.textContent = 'Upload failed';
          setTimeout(() => progressEl.remove(), 3000);
          showError('Failed to get file URL after upload. ' + (err && err.message ? err.message : String(err)));
        }
      });

      fileInput.value = '';
    });

    // Helper: resize image using canvas, returns a Blob
    function resizeImage(file, maxWidth = 1200) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        const reader = new FileReader();
        reader.onload = e => { img.src = e.target.result; };
        img.onerror = reject;
        img.onload = () => {
          const ratio = img.width / img.height;
          const width = Math.min(maxWidth, img.width);
          const height = Math.round(width / ratio);
          const canvas = document.createElement('canvas');
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          canvas.toBlob(blob => {
            if (blob) resolve(blob);
            else reject(new Error('Canvas toBlob failed'));
          }, file.type || 'image/jpeg', 0.85);
        };
        reader.readAsDataURL(file);
      });
    }

    // Show CORS instructions (visible on upload CORS failure)
    function showCorsInstructions(){
      const corsJson = `[
  {
    "origin": ["https://dwellicon.github.io", "http://localhost:5500"],
    "method": ["GET", "POST", "PUT", "HEAD", "OPTIONS"],
    "maxAgeSeconds": 3600,
    "responseHeader": ["Content-Type", "x-goog-resumable"]
  }
]`;
      const gsutilCmd = `# Install and authenticate the Google Cloud SDK, then run:\ngsutil cors set cors.json gs://dwellicon-42e72.appspot.com\n\n# Where cors.json contains the JSON above.`;
      showHelp('CORS or permission error detected.\n\n1) Create a file named cors.json with this content:\n\n' + corsJson + '\n\n2) Run this command from a machine with gsutil authenticated for your Firebase project:\n\n' + gsutilCmd + '\n\nIf you cannot run gsutil, use the Firebase CLI or Cloud Console instructions for configuring Storage CORS. After applying CORS, retry the upload.');
    }

    // Small UX: focus message input on load
    window.addEventListener('load', () => msgInput.focus());
  </script>
</body>
</html>
