<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Chat with Members List</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#f2f6fb;
      --card:#ffffff;
      --muted:#7b8794;
      --accent:#4f46e5;
      --you:#e9f0ff;
      --other:#ffffff;
      --shadow: 0 8px 30px rgba(20,30,60,0.06);
    }
    html,body{
      height:100%;
      margin:0;
      background:linear-gradient(180deg,#eef6ff 0%,var(--bg) 100%);
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      color:#0f1724;
    }

    /* Layout: left chat, right members */
    .layout {
      display:flex;
      height:100vh;
      gap:0;
      align-items:stretch;
    }

    /* Chat column (left) */
    .chat-column {
      flex: 1 1 0;
      display:flex;
      flex-direction:column;
      background:var(--card);
      border-right:1px solid #e6edf6;
      box-shadow: var(--shadow);
      min-width: 0;
    }

    header {
      display:flex;
      align-items:center;
      gap:12px;
      padding:14px 18px;
      border-bottom:1px solid #eef2f7;
      background:linear-gradient(90deg, rgba(79,70,229,0.02), transparent);
    }
    .logo {
      width:44px;height:44px;border-radius:10px;
      background:linear-gradient(135deg,var(--accent),#06b6d4);
      display:flex;align-items:center;justify-content:center;color:white;font-weight:700;
    }
    header h1{font-size:16px;margin:0}
    header p{margin:0;color:var(--muted);font-size:13px}

    /* small name input in header */
    .header-right { margin-left:auto; display:flex; gap:10px; align-items:center; }
    .name-input { padding:8px 10px; border-radius:8px; border:1px solid #eef2f7; width:160px; }

    /* Chat area */
    #chat {
      flex:1;
      padding:18px;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:10px;
      background:linear-gradient(180deg,rgba(79,70,229,0.02),transparent);
    }
    .msg {
      padding:10px;
      background:#fff;
      border-radius:10px;
      box-shadow:0 1px 0 rgba(0,0,0,0.03);
      max-width:70%;
      word-break:break-word;
    }
    .msg .meta { font-size:12px;color:var(--muted);margin-bottom:6px; }

    /* Input bar */
    .input-bar {
      display:flex;
      gap:10px;
      padding:12px;
      border-top:1px solid #eef2f7;
      background:#f8fafc;
      align-items:center;
    }
    .input-bar .input {
      flex:1;
      display:flex;
      gap:8px;
      align-items:center;
      background:#fff;
      padding:8px;
      border-radius:10px;
      border:1px solid #eef2f7;
    }
    .input-bar input[type="text"]{
      flex:1;border:0;background:transparent;padding:8px;font-size:14px;outline:none;
    }
    .btn {
      padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:600;
    }
    .btn.send { background:var(--accent); color:#fff; box-shadow:0 6px 18px rgba(79,70,229,0.12); }
    .btn.attach { background:#10b981; color:#fff; }

    /* Right column: members */
    .members-column {
      width:300px;
      min-width:220px;
      max-width:360px;
      background:#fbfdff;
      border-left:1px solid #e6edf6;
      display:flex;
      flex-direction:column;
      gap:0;
    }
    .members-header {
      padding:14px 16px;
      border-bottom:1px solid #eef2f7;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .members-header h3 { margin:0;font-size:14px; }
    .members-list {
      padding:12px;
      overflow:auto;
      flex:1;
    }
    .member {
      display:flex;
      gap:10px;
      align-items:center;
      padding:8px;
      border-radius:8px;
      transition:background .12s;
    }
    .member:hover { background:rgba(15,23,36,0.03); }
    .member .avatar {
      width:40px;height:40px;border-radius:8px;background:#c7d2fe;color:#0f1724;display:flex;align-items:center;justify-content:center;font-weight:700;
    }
    .member .info { display:flex;flex-direction:column; }
    .member .name { font-weight:600; font-size:14px; }
    .member .status { font-size:12px;color:var(--muted); }

    @media (max-width:900px){
      .members-column{display:none}
    }
  </style>
</head>
<body>
  <div class="layout">
    <!-- Chat column -->
    <div class="chat-column">
      <header>
        <div class="logo">C</div>
        <div>
          <h1>Private Chat</h1>
          <p>Real-time messages powered by Firebase</p>
        </div>

        <div class="header-right">
          <input id="displayNameInput" class="name-input" type="text" placeholder="Your name">
          <button id="signOutBtn" class="btn" style="background:#ef4444;color:#fff;display:none">Sign out</button>
        </div>
      </header>

      <div id="chat" aria-live="polite"></div>

      <div class="input-bar">
        <div class="input" role="group" aria-label="Message input">
          <input id="msg" type="text" placeholder="Write a message…" aria-label="Message">
        </div>
        <button id="attach" class="btn attach" aria-label="Attach file">Attach</button>
        <button id="send" class="btn send" aria-label="Send message">Send</button>
      </div>
    </div>

    <!-- Members column -->
    <aside class="members-column" aria-label="Members">
      <div class="members-header">
        <h3>Members</h3>
        <div id="onlineCount" class="small">0 online</div>
      </div>
      <div class="members-list" id="membersList">
        <!-- live members will be appended here -->
      </div>
    </aside>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // ====== CONFIG: paste your firebaseConfig here ======
    const firebaseConfig = {
      apiKey: "AIzaSyAulcwmA2r2Z0Wv5mxyuWwQvPv05E8HvMU",
      authDomain: "dwellicon-42e72.firebaseapp.com",
      databaseURL: "https://dwellicon-42e72-default-rtdb.firebaseio.com",
      projectId: "dwellicon-42e72",
      storageBucket: "dwellicon-42e72.appspot.com",
      messagingSenderId: "634657717896",
      appId: "1:634657717896:web:27f246614fdb2c2398a93d",
      measurementId: "G-GP1YBL86RB"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // UI elements
    const chatEl = document.getElementById('chat');
    const msgInput = document.getElementById('msg');
    const sendBtn = document.getElementById('send');
    const attachBtn = document.getElementById('attach');
    const displayNameInput = document.getElementById('displayNameInput');
    const signOutBtn = document.getElementById('signOutBtn');

    const membersListEl = document.getElementById('membersList');
    const onlineCountEl = document.getElementById('onlineCount');

    // Presence root path
    const PRESENCE_ROOT = 'presence';

    // Messages ref
    const MESSAGES_REF = 'messages';

    // Local session: if user hasn't set a name, create a guest name
    function currentUser() {
      const stored = localStorage.getItem('chat_user');
      if (stored) return JSON.parse(stored);
      // create a guest identity
      const guestName = 'Guest-' + Math.random().toString(36).slice(2,8);
      const uid = 'guest_' + Date.now().toString(36);
      const user = { username: guestName, uid };
      localStorage.setItem('chat_user', JSON.stringify(user));
      return user;
    }

    // Allow user to change display name in header
    const user = currentUser();
    displayNameInput.value = user.username || '';
    displayNameInput.addEventListener('change', () => {
      const newName = (displayNameInput.value || '').trim() || user.username;
      const updated = { ...user, username: newName };
      localStorage.setItem('chat_user', JSON.stringify(updated));
      // update presence record if exists
      db.ref(`${PRESENCE_ROOT}/${updated.uid}`).update({ username: newName }).catch(()=>{});
    });

    // Presence: write presence record and set onDisconnect removal
    let presenceRef = null;
    function startPresence(uid, username) {
      try {
        presenceRef = db.ref(`${PRESENCE_ROOT}/${uid}`);
        const data = { username, online: true, lastSeen: Date.now() };
        presenceRef.set(data).catch(()=>{});
        presenceRef.onDisconnect().remove().catch(()=>{});
        presenceHeartbeat(uid, username);
      } catch (e) {
        console.warn('presence start error', e);
      }
    }
    let heartbeatTimer = null;
    function presenceHeartbeat(uid, username) {
      if (heartbeatTimer) clearInterval(heartbeatTimer);
      heartbeatTimer = setInterval(() => {
        db.ref(`${PRESENCE_ROOT}/${uid}`).update({ lastSeen: Date.now(), online: true, username }).catch(()=>{});
      }, 25000);
    }
    function stopPresence(uid) {
      if (heartbeatTimer) clearInterval(heartbeatTimer);
      if (presenceRef) {
        presenceRef.remove().catch(()=>{});
        presenceRef = null;
      }
    }

    // Messages: listen and render
    let messagesRef = null;
    function startListeningMessages() {
      if (messagesRef) return;
      messagesRef = db.ref(MESSAGES_REF);
      messagesRef.limitToLast(200).on('child_added', snap => {
        appendChatMessage(snap.val());
      }, err => {
        appendSystemMessage('Realtime listen error: ' + (err && err.message ? err.message : err));
      });
    }
    function stopListeningMessages() {
      if (!messagesRef) return;
      messagesRef.off();
      messagesRef = null;
      chatEl.innerHTML = '';
    }

    function appendSystemMessage(text) {
      const el = document.createElement('div');
      el.className = 'msg';
      el.style.opacity = '0.9';
      el.textContent = text;
      chatEl.appendChild(el);
      chatEl.scrollTop = chatEl.scrollHeight;
    }
    function appendChatMessage(data) {
      const el = document.createElement('div');
      el.className = 'msg';
      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.textContent = (data.name || 'Guest') + ' • ' + new Date(data.ts || Date.now()).toLocaleTimeString();
      const body = document.createElement('div');
      body.textContent = data.text || '';
      el.appendChild(meta);
      el.appendChild(body);
      chatEl.appendChild(el);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    // Send message
    sendBtn.addEventListener('click', async () => {
      const raw = msgInput.value || '';
      const text = raw.replace(/\r?\n|\r/g,' ').trim().slice(0,300);
      if (!text) return;
      const user = JSON.parse(localStorage.getItem('chat_user') || 'null');
      if (!user) { alert('No user'); return; }
      const name = user.username || 'Guest';
      try {
        await db.ref(MESSAGES_REF).push({ name, text, ts: Date.now(), uid: user.uid || null });
        msgInput.value = '';
      } catch (err) {
        console.error('push error', err);
        appendSystemMessage('Send failed: ' + (err && err.message ? err.message : err));
      }
    });
    msgInput.addEventListener('keydown', e => { if (e.key === 'Enter') sendBtn.click(); });

    // Members list: listen to presence
    let presenceListener = null;
    function startMembersListener() {
      const ref = db.ref(PRESENCE_ROOT);
      presenceListener = ref;
      ref.on('value', snap => {
        const val = snap.val() || {};
        renderMembers(val);
      }, err => {
        console.error('presence listen error', err);
      });
    }
    function stopMembersListener() {
      if (presenceListener) {
        presenceListener.off();
        presenceListener = null;
      }
      clearMembers();
    }

    function renderMembers(obj) {
      membersListEl.innerHTML = '';
      const entries = Object.entries(obj || {});
      // sort: online first by lastSeen desc
      entries.sort((a,b) => {
        const A = a[1] || {}, B = b[1] || {};
        const aOnline = A.online ? 1 : 0, bOnline = B.online ? 1 : 0;
        if (aOnline !== bOnline) return bOnline - aOnline;
        return (B.lastSeen || 0) - (A.lastSeen || 0);
      });
      entries.forEach(([uid, info]) => {
        const member = document.createElement('div');
        member.className = 'member';
        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        avatar.textContent = (info.username || 'U').slice(0,2).toUpperCase();
        const infoWrap = document.createElement('div');
        infoWrap.className = 'info';
        const name = document.createElement('div');
        name.className = 'name';
        name.textContent = info.username || uid;
        const status = document.createElement('div');
        status.className = 'status';
        status.textContent = info.online ? 'online' : 'last seen ' + timeAgo(info.lastSeen || Date.now());
        infoWrap.appendChild(name);
        infoWrap.appendChild(status);
        member.appendChild(avatar);
        member.appendChild(infoWrap);
        membersListEl.appendChild(member);
      });
      onlineCountEl.textContent = entries.length + ' online';
    }

    function clearMembers() {
      membersListEl.innerHTML = '';
      onlineCountEl.textContent = '0 online';
    }

    function timeAgo(ts) {
      const s = Math.floor((Date.now() - ts) / 1000);
      if (s < 10) return 'just now';
      if (s < 60) return s + 's';
      const m = Math.floor(s/60);
      if (m < 60) return m + 'm';
      const h = Math.floor(m/60);
      return h + 'h';
    }

    // Initialize: start message listener, presence, members
    (function init() {
      const user = currentUser();
      // ensure displayNameInput shows current name
      displayNameInput.value = user.username || '';
      // start presence and listeners
      startListeningMessages();
      startMembersListener();
      startPresence(user.uid, user.username);
      appendSystemMessage('You are signed in as ' + user.username);
    })();

    // Remove presence on unload
    window.addEventListener('beforeunload', () => {
      const user = JSON.parse(localStorage.getItem('chat_user') || 'null');
      if (user && user.uid) {
        db.ref(`${PRESENCE_ROOT}/${user.uid}`).remove();
      }
    });

    // Optional sign out button (clears local identity and creates a new guest)
    signOutBtn.addEventListener('click', () => {
      const old = JSON.parse(localStorage.getItem('chat_user') || 'null');
      if (old && old.uid) db.ref(`${PRESENCE_ROOT}/${old.uid}`).remove().catch(()=>{});
      localStorage.removeItem('chat_user');
      // create new guest and reload to apply
      currentUser();
      location.reload();
    });

    // Show signOutBtn only if user is not a guest id starting with guest_
    (function toggleSignOutVisibility() {
      const u = JSON.parse(localStorage.getItem('chat_user') || 'null');
      if (u && u.uid && !String(u.uid).startsWith('guest_')) {
        signOutBtn.style.display = 'inline-block';
      } else {
        signOutBtn.style.display = 'none';
      }
    })();
  </script>
</body>
</html>
