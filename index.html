<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Chat with Members & Admin Tools</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#f2f6fb;
      --card:#ffffff;
      --muted:#7b8794;
      --accent:#4f46e5;
      --admin-yellow:#f59e0b;
      --you:#e9f0ff;
      --shadow: 0 8px 30px rgba(20,30,60,0.06);
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#eef6ff 0%,var(--bg) 100%);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:#0f1724}
    .layout{display:flex;height:100vh;align-items:stretch}
    .chat-column{flex:1;display:flex;flex-direction:column;background:var(--card);border-right:1px solid #e6edf6;box-shadow:var(--shadow);min-width:0}
    header{display:flex;align-items:center;gap:12px;padding:14px 18px;border-bottom:1px solid #eef2f7;background:linear-gradient(90deg, rgba(79,70,229,0.02), transparent)}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#06b6d4);display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
    header h1{font-size:16px;margin:0}
    header p{margin:0;color:var(--muted);font-size:13px}
    .header-right{margin-left:auto;display:flex;gap:10px;align-items:center}
    .name-input{padding:8px 10px;border-radius:8px;border:1px solid #eef2f7;width:160px}
    #chat{flex:1;padding:18px;overflow:auto;display:flex;flex-direction:column;gap:10px;background:linear-gradient(180deg,rgba(79,70,229,0.02),transparent)}
    .msg{padding:10px;background:#fff;border-radius:10px;box-shadow:0 1px 0 rgba(0,0,0,0.03);max-width:70%;word-break:break-word;position:relative}
    .msg .meta{font-size:12px;color:var(--muted);margin-bottom:6px;display:flex;gap:8px;align-items:center}
    .admin-badge{background:var(--admin-yellow);color:#1f2937;padding:2px 8px;border-radius:999px;font-weight:700;font-size:11px}
    .input-bar{display:flex;gap:10px;padding:12px;border-top:1px solid #eef2f7;background:#f8fafc;align-items:center}
    .input{flex:1;display:flex;gap:8px;align-items:center;background:#fff;padding:8px;border-radius:10px;border:1px solid #eef2f7}
    .input input{flex:1;border:0;background:transparent;padding:8px;font-size:14px;outline:none}
    .btn{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:600}
    .btn.send{background:var(--accent);color:#fff}
    .btn.attach{background:#10b981;color:#fff}
    .members-column{width:300px;min-width:220px;max-width:360px;background:#fbfdff;border-left:1px solid #e6edf6;display:flex;flex-direction:column}
    .members-header{padding:14px 16px;border-bottom:1px solid #eef2f7;display:flex;align-items:center;justify-content:space-between}
    .members-header h3{margin:0;font-size:14px}
    .members-list{padding:12px;overflow:auto;flex:1}
    .member{display:flex;gap:10px;align-items:center;padding:8px;border-radius:8px;transition:background .12s;cursor:pointer}
    .member:hover{background:rgba(15,23,36,0.03)}
    .member .avatar{width:40px;height:40px;border-radius:8px;background:#c7d2fe;color:#0f1724;display:flex;align-items:center;justify-content:center;font-weight:700}
    .member .info{display:flex;flex-direction:column}
    .member .name{font-weight:600;font-size:14px;display:flex;gap:8px;align-items:center}
    .member .status{font-size:12px;color:var(--muted)}
    .overlay{position:fixed;inset:0;background:rgba(10,12,20,0.45);display:flex;align-items:center;justify-content:center;z-index:999;display:none}
    .modal{background:white;padding:16px;border-radius:10px;min-width:320px;box-shadow:0 12px 40px rgba(10,20,40,0.3)}
    .modal h3{margin:0 0 8px 0}
    .modal .row{display:flex;gap:8px;margin-top:12px}
    .danger{background:#ef4444;color:white}
    .muted{color:var(--muted);font-size:13px}
    .banner{position:fixed;left:16px;bottom:16px;background:#fff;padding:10px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.08);font-size:13px;display:none}
    .block-screen{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:1000;color:white;font-size:18px;display:none}
    .block-screen .card{background:rgba(255,255,255,0.06);padding:20px;border-radius:10px;text-align:center}
    @media (max-width:900px){.members-column{display:none}}
  </style>
</head>
<body>
  <div class="layout">
    <div class="chat-column">
      <header>
        <div class="logo">C</div>
        <div>
          <h1>Private Chat</h1>
          <p class="muted">Real-time messages — admin: Kyson</p>
        </div>
        <div class="header-right">
          <input id="displayNameInput" class="name-input" type="text" placeholder="Your name">
          <button id="banlandBtn" class="btn" title="Alt+X to open Banland" style="background:#f59e0b;color:#fff;display:none">Banland</button>
        </div>
      </header>

      <div id="chat" aria-live="polite"></div>

      <div class="input-bar">
        <div class="input" role="group" aria-label="Message input">
          <input id="msg" type="text" placeholder="Write a message…" aria-label="Message">
        </div>
        <button id="attach" class="btn attach" aria-label="Attach file">Attach</button>
        <button id="send" class="btn send" aria-label="Send message">Send</button>
      </div>
    </div>

    <aside class="members-column" aria-label="Members">
      <div class="members-header">
        <h3>Members</h3>
        <div id="onlineCount" class="muted">0 online</div>
      </div>
      <div class="members-list" id="membersList"></div>
    </aside>
  </div>

  <div id="memberModal" class="overlay">
    <div class="modal" role="dialog" aria-modal="true">
      <h3 id="modalName">Member</h3>
      <div id="modalUid" class="muted" style="font-size:12px"></div>
      <div style="margin-top:10px" id="modalStatus" class="muted"></div>
      <div class="row" style="margin-top:12px">
        <button id="kickBtn" class="btn danger">Kick</button>
        <button id="banBtn" class="btn" style="background:#6b7280;color:#fff">Ban</button>
        <button id="closeModal" class="btn" style="background:#e5e7eb">Close</button>
      </div>
    </div>
  </div>

  <div id="banlandModal" class="overlay">
    <div class="modal" role="dialog" aria-modal="true">
      <h3>Banland (unban)</h3>
      <div id="banList" style="max-height:300px;overflow:auto;margin-top:8px"></div>
      <div class="row" style="margin-top:12px">
        <button id="closeBanland" class="btn" style="background:#e5e7eb">Close</button>
      </div>
    </div>
  </div>

  <div id="kickedScreen" class="block-screen">
    <div class="card">
      <div style="font-size:20px;font-weight:700">You were kicked</div>
      <div style="margin-top:8px">You cannot send messages in this session. Refresh to rejoin.</div>
    </div>
  </div>

  <div id="bannedScreen" class="block-screen">
    <div class="card">
      <div style="font-size:20px;font-weight:700">You are banned</div>
      <div style="margin-top:8px">This browser is banned from this chat. Unban from Banland to restore access.</div>
    </div>
  </div>

  <div id="banner" class="banner"></div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    /* ====== CONFIG: paste your firebaseConfig here ====== */
    const firebaseConfig = {
      apiKey: "AIzaSyAulcwmA2r2Z0Wv5mxyuWwQvPv05E8HvMU",
      authDomain: "dwellicon-42e72.firebaseapp.com",
      databaseURL: "https://dwellicon-42e72-default-rtdb.firebaseio.com",
      projectId: "dwellicon-42e72",
      storageBucket: "dwellicon-42e72.appspot.com",
      messagingSenderId: "634657717896",
      appId: "1:634657717896:web:27f246614fdb2c2398a93d",
      measurementId: "G-GP1YBL86RB"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // DOM
    const chatEl = document.getElementById('chat');
    const msgInput = document.getElementById('msg');
    const sendBtn = document.getElementById('send');
    const displayNameInput = document.getElementById('displayNameInput');
    const membersListEl = document.getElementById('membersList');
    const onlineCountEl = document.getElementById('onlineCount');
    const banner = document.getElementById('banner');

    const memberModal = document.getElementById('memberModal');
    const modalName = document.getElementById('modalName');
    const modalUid = document.getElementById('modalUid');
    const modalStatus = document.getElementById('modalStatus');
    const kickBtn = document.getElementById('kickBtn');
    const banBtn = document.getElementById('banBtn');
    const closeModal = document.getElementById('closeModal');

    const banlandModal = document.getElementById('banlandModal');
    const banListEl = document.getElementById('banList');
    const banlandBtn = document.getElementById('banlandBtn');
    const closeBanland = document.getElementById('closeBanland');

    const kickedScreen = document.getElementById('kickedScreen');
    const bannedScreen = document.getElementById('bannedScreen');

    // DB paths
    const PRESENCE_ROOT = 'presence';
    const MESSAGES_REF = 'messages';
    const KICKS_ROOT = 'kicks';
    const BANS_ROOT = 'bans';

    // helpers
    function showBanner(text, ms = 2500) {
      banner.textContent = text;
      banner.style.display = 'block';
      setTimeout(()=> banner.style.display = 'none', ms);
    }

    function now() { return Date.now(); }

    // local user
    function currentUser() {
      const stored = localStorage.getItem('chat_user');
      if (stored) return JSON.parse(stored);
      const guestName = 'Guest-' + Math.random().toString(36).slice(2,8);
      const uid = 'guest_' + Date.now().toString(36);
      const user = { username: guestName, uid };
      localStorage.setItem('chat_user', JSON.stringify(user));
      return user;
    }

    function setUserName(name) {
      const u = currentUser();
      u.username = name;
      localStorage.setItem('chat_user', JSON.stringify(u));
      // update presence with isAdmin flag
      db.ref(`${PRESENCE_ROOT}/${u.uid}`).update({ username: name, isAdmin: (name === 'Kyson') }).catch(()=>{});
      updateAdminUI();
    }

    function isAdminLocal() {
      const u = currentUser();
      return (u && u.username === 'Kyson');
    }

    function updateAdminUI() {
      if (isAdminLocal()) banlandBtn.style.display = 'inline-block';
      else banlandBtn.style.display = 'none';
    }

    // presence
    let presenceRef = null;
    let heartbeatTimer = null;
    function startPresence(uid, username) {
      presenceRef = db.ref(`${PRESENCE_ROOT}/${uid}`);
      const isAdmin = (username === 'Kyson');
      presenceRef.set({ username, online: true, lastSeen: now(), isAdmin }).catch(()=>{});
      presenceRef.onDisconnect().remove().catch(()=>{});
      if (heartbeatTimer) clearInterval(heartbeatTimer);
      heartbeatTimer = setInterval(()=> {
        db.ref(`${PRESENCE_ROOT}/${uid}`).update({ lastSeen: now(), online: true, username, isAdmin }).catch(()=>{});
      }, 25000);
    }
    function stopPresence(uid) {
      if (heartbeatTimer) clearInterval(heartbeatTimer);
      if (presenceRef) { presenceRef.remove().catch(()=>{}); presenceRef = null; }
    }

    // messages
    let messagesRef = null;
    function startMessages() {
      if (messagesRef) return;
      messagesRef = db.ref(MESSAGES_REF);
      messagesRef.limitToLast(500).on('child_added', snap => {
        appendChatMessage(snap.val());
      }, err => appendSystemMessage('Listen error: ' + (err && err.message ? err.message : err)));
    }
    function appendSystemMessage(text) {
      const el = document.createElement('div');
      el.className = 'msg';
      el.style.opacity = '0.9';
      el.textContent = text;
      chatEl.appendChild(el);
      chatEl.scrollTop = chatEl.scrollHeight;
    }
    function appendChatMessage(data) {
      const el = document.createElement('div');
      el.className = 'msg';
      const meta = document.createElement('div');
      meta.className = 'meta';
      const nameSpan = document.createElement('span');
      nameSpan.textContent = data.name || 'Guest';
      meta.appendChild(nameSpan);

      // show admin badge if message flagged or name is Kyson
      if (data.isAdmin || (data.name === 'Kyson')) {
        const badge = document.createElement('span');
        badge.className = 'admin-badge';
        badge.textContent = 'ADMIN';
        meta.appendChild(badge);
      }

      const timeSpan = document.createElement('span');
      timeSpan.style.marginLeft = '8px';
      timeSpan.style.color = 'var(--muted)';
      timeSpan.textContent = '• ' + new Date(data.ts || Date.now()).toLocaleTimeString();
      meta.appendChild(timeSpan);

      const body = document.createElement('div');
      body.textContent = data.text || '';
      el.appendChild(meta);
      el.appendChild(body);
      chatEl.appendChild(el);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    // send message (include isAdmin flag)
    sendBtn.addEventListener('click', sendMessage);
    msgInput.addEventListener('keydown', e => { if (e.key === 'Enter') sendMessage(); });

    function sendMessage() {
      if (isKickedThisSession()) { showBanner('You are kicked this session'); return; }
      if (isBannedLocal()) { showBanner('You are banned'); return; }
      const raw = msgInput.value || '';
      const text = raw.replace(/\r?\n|\r/g,' ').trim().slice(0,300);
      if (!text) return;
      const u = currentUser();
      const isAdmin = (u.username === 'Kyson');
      db.ref(MESSAGES_REF).push({ name: u.username, text, ts: now(), uid: u.uid, isAdmin }).then(()=> {
        msgInput.value = '';
      }).catch(err => {
        console.error('push error', err);
        appendSystemMessage('Send failed: ' + (err && err.message ? err.message : err));
      });
    }

    // members list
    let presenceListener = null;
    function startMembersListener() {
      const ref = db.ref(PRESENCE_ROOT);
      presenceListener = ref;
      ref.on('value', snap => {
        const val = snap.val() || {};
        renderMembers(val);
      }, err => console.error('presence listen error', err));
    }
    function renderMembers(obj) {
      membersListEl.innerHTML = '';
      const entries = Object.entries(obj || {});
      entries.sort((a,b) => {
        const A = a[1]||{}, B = b[1]||{};
        const aOnline = A.online ? 1 : 0, bOnline = B.online ? 1 : 0;
        if (aOnline !== bOnline) return bOnline - aOnline;
        return (B.lastSeen||0) - (A.lastSeen||0);
      });
      entries.forEach(([uid, info]) => {
        const member = document.createElement('div');
        member.className = 'member';
        member.dataset.uid = uid;
        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        avatar.textContent = (info.username || 'U').slice(0,2).toUpperCase();
        const infoWrap = document.createElement('div');
        infoWrap.className = 'info';
        const name = document.createElement('div');
        name.className = 'name';
        name.textContent = info.username || uid;
        // show admin badge if presence says isAdmin or username is Kyson
        if (info.isAdmin || (info.username === 'Kyson')) {
          const adminTag = document.createElement('span');
          adminTag.className = 'admin-badge';
          adminTag.textContent = 'ADMIN';
          adminTag.style.marginLeft = '8px';
          name.appendChild(adminTag);
        }
        const status = document.createElement('div');
        status.className = 'status';
        status.textContent = info.online ? 'online' : 'last seen ' + timeAgo(info.lastSeen || Date.now());
        infoWrap.appendChild(name);
        infoWrap.appendChild(status);
        member.appendChild(avatar);
        member.appendChild(infoWrap);

        member.addEventListener('click', () => openMemberModal(uid, info));
        membersListEl.appendChild(member);
      });
      onlineCountEl.textContent = entries.length + ' online';
    }

    function timeAgo(ts) {
      const s = Math.floor((Date.now() - ts) / 1000);
      if (s < 10) return 'just now';
      if (s < 60) return s + 's';
      const m = Math.floor(s/60);
      if (m < 60) return m + 'm';
      const h = Math.floor(m/60);
      return h + 'h';
    }

    // member modal
    let modalTargetUid = null;
    function openMemberModal(uid, info) {
      modalTargetUid = uid;
      modalName.textContent = info.username || uid;
      modalUid.textContent = uid;
      modalStatus.textContent = info.online ? 'online' : 'offline';
      if (isAdminLocal()) {
        kickBtn.style.display = 'inline-block';
        banBtn.style.display = 'inline-block';
      } else {
        kickBtn.style.display = 'none';
        banBtn.style.display = 'none';
      }
      memberModal.style.display = 'flex';
    }
    closeModal.addEventListener('click', ()=> memberModal.style.display = 'none');

    // Kick: write to /kicks/{uid}
    kickBtn.addEventListener('click', async () => {
      if (!modalTargetUid) return;
      const u = currentUser();
      if (!isAdminLocal()) { showBanner('Admin only'); return; }
      try {
        await db.ref(`${KICKS_ROOT}/${modalTargetUid}`).set({ ts: now(), by: u.uid, byName: u.username });
        showBanner('Kick sent');
      } catch (err) {
        console.error('kick error', err);
        showBanner('Kick failed');
      }
      memberModal.style.display = 'none';
    });

    // Ban: write to /bans/{uid}
    banBtn.addEventListener('click', async () => {
      if (!modalTargetUid) return;
      const u = currentUser();
      if (!isAdminLocal()) { showBanner('Admin only'); return; }
      try {
        // store username for Banland display
        const targetName = document.querySelector(`.member[data-uid="${modalTargetUid}"] .name`)?.textContent || modalTargetUid;
        await db.ref(`${BANS_ROOT}/${modalTargetUid}`).set({ ts: now(), by: u.uid, byName: u.username, username: targetName });
        showBanner('Ban applied');
      } catch (err) {
        console.error('ban error', err);
        showBanner('Ban failed');
      }
      memberModal.style.display = 'none';
    });

    // Kick listener
    function startKickListener() {
      db.ref(KICKS_ROOT).on('child_added', snap => {
        const targetUid = snap.key;
        const data = snap.val();
        const me = currentUser();
        if (me && me.uid === targetUid) {
          // show kicked overlay and set session flag
          localStorage.setItem(`kicked_${me.uid}`, '1');
          showKicked();
        }
        // auto-remove kick after 30s so it's temporary
        setTimeout(()=> db.ref(`${KICKS_ROOT}/${targetUid}`).remove().catch(()=>{}), 30000);
      });
    }

    // Ban listener
    function startBanListener() {
      const ref = db.ref(BANS_ROOT);
      ref.on('child_added', snap => {
        const targetUid = snap.key;
        const data = snap.val() || {};
        const me = currentUser();
        // set local banned flag for the target (persist across refresh)
        localStorage.setItem(`banned_${targetUid}`, JSON.stringify({ ts: data.ts || now(), by: data.by || null, byName: data.byName || null, username: data.username || null }));
        if (me && me.uid === targetUid) {
          showBanned();
        }
        refreshBanland();
      });
      ref.on('child_removed', snap => {
        const targetUid = snap.key;
        localStorage.removeItem(`banned_${targetUid}`);
        const me = currentUser();
        if (me && me.uid === targetUid) hideBanned();
        refreshBanland();
      });
    }

    // Kicked UI
    function showKicked() { kickedScreen.style.display = 'flex'; }
    function hideKicked() { kickedScreen.style.display = 'none'; }
    function isKickedThisSession() { return !!localStorage.getItem(`kicked_${currentUser().uid}`); }

    // Banned UI
    function showBanned() { bannedScreen.style.display = 'flex'; }
    function hideBanned() { bannedScreen.style.display = 'none'; }
    function isBannedLocal() { return !!localStorage.getItem(`banned_${currentUser().uid}`); }

    // Banland
    banlandBtn.addEventListener('click', openBanland);
    closeBanland.addEventListener('click', ()=> banlandModal.style.display = 'none');

    async function openBanland() {
      if (!isAdminLocal()) { showBanner('Admin only'); return; }
      await refreshBanland();
      banlandModal.style.display = 'flex';
    }

    async function refreshBanland() {
      const snap = await db.ref(BANS_ROOT).once('value');
      const bans = snap.val() || {};
      banListEl.innerHTML = '';
      const entries = Object.entries(bans);
      if (entries.length === 0) {
        banListEl.textContent = 'No banned users';
        return;
      }
      entries.forEach(([uid, info]) => {
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.justifyContent = 'space-between';
        row.style.alignItems = 'center';
        row.style.padding = '8px 0';
        const left = document.createElement('div');
        left.textContent = (info.username || uid) + ' • ' + uid;
        const btn = document.createElement('button');
        btn.textContent = 'Unban';
        btn.className = 'btn';
        btn.style.background = '#10b981';
        btn.style.color = '#fff';
        btn.addEventListener('click', () => {
          db.ref(`${BANS_ROOT}/${uid}`).remove().then(()=> showBanner('Unbanned')).catch(()=> showBanner('Unban failed'));
        });
        row.appendChild(left);
        row.appendChild(btn);
        banListEl.appendChild(row);
      });
    }

    // init
    (function init() {
      const u = currentUser();
      displayNameInput.value = u.username || '';
      updateAdminUI();
      startPresence(u.uid, u.username);
      startMessages();
      startMembersListener();
      startKickListener();
      startBanListener();
      // if banned locally, show banned screen
      if (isBannedLocal()) showBanned();
      appendSystemMessage('You are signed in as ' + u.username + (isAdminLocal() ? ' (admin)' : ''));
    })();

    // displayName change
    displayNameInput.addEventListener('change', () => {
      const name = (displayNameInput.value || '').trim() || currentUser().username;
      setUserName(name);
    });

    // remove presence on unload
    window.addEventListener('beforeunload', () => {
      const u = currentUser();
      if (u && u.uid) db.ref(`${PRESENCE_ROOT}/${u.uid}`).remove().catch(()=>{});
    });

    // Alt+X opens Banland
    window.addEventListener('keydown', (e) => {
      if (e.altKey && (e.key === 'x' || e.key === 'X')) {
        openBanland();
      }
    });

    // close modals on outside click
    memberModal.addEventListener('click', (ev) => { if (ev.target === memberModal) memberModal.style.display = 'none'; });
    banlandModal.addEventListener('click', (ev) => { if (ev.target === banlandModal) banlandModal.style.display = 'none'; });

    // helper: set username and presence update
    function setUserName(name) {
      const u = currentUser();
      u.username = name;
      localStorage.setItem('chat_user', JSON.stringify(u));
      db.ref(`${PRESENCE_ROOT}/${u.uid}`).update({ username: name, isAdmin: (name === 'Kyson') }).catch(()=>{});
      updateAdminUI();
    }

    // helper: currentUser (duplicate safe)
    function currentUser() {
      const stored = localStorage.getItem('chat_user');
      if (stored) return JSON.parse(stored);
      const guestName = 'Guest-' + Math.random().toString(36).slice(2,8);
      const uid = 'guest_' + Date.now().toString(36);
      const user = { username: guestName, uid };
      localStorage.setItem('chat_user', JSON.stringify(user));
      return user;
    }

    // small console helpers
    window.__chatHelpers = { currentUser, isAdminLocal, isBannedLocal, isKickedThisSession, showBanner };
  </script>
</body>
</html>
